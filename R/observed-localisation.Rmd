---
title: "interation-analysis"
author: "Olivier GAUFRÃˆS"
date: "2024-04-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(lubridate)
library(ggplot2)
```

## File paths
```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)
observed_path <- file.path(wd,"..", "data","data-observed")
synthetic_path <- file.path(wd, "..", "data", "data-synthetic-graphs")
simplified_path <- file.path(wd, "..", "data", "data-simplified")
expanded_path <- file.path(wd,"..", "data","data-expanded")
```

## i-Bird study data
```{r}
begin_date <- as.POSIXct("2009-07-06 00:00:00")
end_date <- as.POSIXct("2009-09-28 00:00:00")
time_spent <- end_date - begin_date
n_subdivisions <- as.integer(time_spent) * 24 * 60 * 2 ## Time spent * hours * minutes * 2 (number of time subdivisions)
```

## Data import
```{r}
## NA when the individual is still in the hospital --> we fill these NAs
admission <- read.csv2(file = file.path(simplified_path, "admission.csv"))
admission <- admission %>% mutate(lastDate = ifelse(nchar(lastDate) == 0, "2999-01-01", lastDate))

## id of all individuals in the 84 days range
id_individual <- admission %>% distinct(id)

## MENARD 1 HAS 28 BEDS
n_beds <- 28

## Observed data from i-Bird study
data <- read.csv2(file = file.path(simplified_path, "mat_ctc.csv"), header = TRUE, sep = ";") %>% 
                      mutate(date_posix = as.POSIXct(date_posix, tz="GMT"))
                      #mutate(date_posix = format(as.POSIXct(date_posix, tz="GMT"), format="%Y-%m-%d %H:%M:%S")) ##TEMPORARY, FIX TO AVOID YYYY-MM-DD 00:00:00 formated as YYYY-MM-DD

#(as.POSIXct(max(data_observed$date_posix), tz="GMT")) - (as.POSIXct(min(data_observed$date_posix), tz="GMT"))

## Date range of 84 days ($time_spent)
data <- data %>% filter(begin_date <= date_posix) %>% filter(date_posix <= end_date)
```


## Interaction's duration of 30sec
```{r}
k_30 = data %>% filter(length == 30) %>% mutate(from = gsub("-.*", "", from), to = gsub("-.*", "", to)) %>% select(-date_posix)
print("Interaction's duration of 30sec")
table(k_30$from, k_30$to)

## Proportions of interaction of 30s in all the int
print("Proportions of interaction of 30s")
prop.table(table(k_30$from, k_30$to))


print("Proportions of 30s int in all the int")
print(paste0(nrow(k_30)/nrow(data) * 100, " %"))
rm(k_30)
```


## Interaction's duration < 300sec
```{r}
k_300= data %>% filter(length < 300) %>% mutate(from = gsub("-.*", "", from), to = gsub("-.*", "", to)) %>% select(-date_posix)
prop.table(table(k_300$from, k_300$to))

print("Proportions of interaction < 300s in all the int")
print(paste0(nrow(k_300)/nrow(data) * 100, " %"))
rm(k_300)
```





## ROOM INFERENCE BASED ON NIGHT INTERACTIONS


## Night interactions (0am-5am)
```{r}
night_data <- data  %>%
  filter(hour(data$date_posix) <= 4) 

## Check if there is PE in night's interactions
which(substr(night_data$from, 1, 2) == "PE" | substr(night_data$to, 1, 2) == "PE" )

## Filter to keep only long interactions
night_data <- data %>%
  filter(length >= 300)
```


```{r}
tot <- NULL
## Range of amount of interactions happening at night + distinct individuals involved + number of days there is less than n_beds individuals interacting at night
for (i in 1:60){
  temp <- data  %>% filter(hour(data$date_posix) <=  4) %>%
  filter (length >= 60 * 5 * i) %>%
  group_by(date(date_posix)) %>%
  summarise(count = n(), count_distinct = length(unique(c(from, to)))) %>%
  summarise(min_count = min(count),
            max_count = max(count),
            min_distinct = min(count_distinct),
            max_distinct = max(count_distinct),
            count_under = sum((count_distinct) < n_beds))
  
  temp$time_night_s <- 60 * 5 * i
  temp$time_night_min <- i * 5
  tot <- bind_rows(tot, temp)
}
tot <- tot %>% select(time_night_min, min_count, max_count, min_distinct, max_distinct,count_under)


## ELBOW RULE TO FIND TIME

ggplot(data = tot) +
  geom_point(mapping = aes(x = time_night_min, y = min_count, color = "Minimum Count"), show.legend = TRUE) +
  geom_line(mapping = aes(x = time_night_min, y = min_count), linetype = "dashed") +
  
  geom_point(mapping = aes(x = time_night_min, y = max_count, color = "Maximum Count"), show.legend = TRUE) +
  geom_line(mapping = aes(x = time_night_min, y = max_count), linetype = "dashed") +
  
  geom_point(mapping = aes(x = time_night_min, y = min_distinct, color = "Minimum Distinct"), show.legend = TRUE) +
  geom_line(mapping = aes(x = time_night_min, y = min_distinct), linetype = "dashed") +
  
  geom_point(mapping = aes(x = time_night_min, y = max_distinct, color = "Maximum Distinct"), show.legend = TRUE) +
  geom_line(mapping = aes(x = time_night_min, y = max_distinct), linetype = "dashed") +
  
  scale_color_manual(values = c("Minimum Count" = "red", 
                                 "Maximum Count" = "darkred",
                                 "Minimum Distinct" = "blue",
                                 "Maximum Distinct" = "darkblue")) +
  labs( x = "Time (min)", y = "Interactions (red) & Distinct individuals (blue)") +
  labs(title = "Interactions at night in Menard 1") +
  theme(legend.position = "top")

print(tot)

## issue w/ the colors???


```

## Filtration according to these assumptions
```{r}
## WE CHOOSE TO HAVE MORE INTERACTIONS THAN DISTINCT INDIVIDUALS INTERACTING
## WE CHOOSE TO SET THE THRESHOLD OF LENGTH FOR A NIGHT INTERACTION TO 40 minutes -> 2400 seconds

length_thresold <- 40 * 60
hour_thresold <- 4

## Inspection (for 1 day = begin_date)
test_graph <- data  %>%
  filter(hour(data$date_posix) <= hour_thresold) %>%
  filter(length >= length_thresold) %>% filter( date(date_posix) == date(begin_date)) 

## Nb of interactions during the night & distinct individuals involved
print (data  %>%
  filter(hour(data$date_posix) <= hour_thresold) %>%
  filter(length >= length_thresold) %>% filter( date(date_posix) == date(begin_date)) %>%
  group_by(date(date_posix)) %>%
  summarise(count = n(), count_distinct = length(unique(c(from, to)))))


id_unique <- sort(unique(c(test_graph$from,test_graph$to)))


## INDIVIDUALS IN THE WARD ACCORDING TO ADMISSION DATA
id_present <- admission_modified %>% filter(firstDate <= begin_date & lastDate >= begin_date + days(1)) %>% distinct(id) %>% filter(substr(id,1,2) == "PA")

date_distinct <- data %>% group_by(date(date_posix)) %>% select(-c(from,to,length,date_posix)) %>% distinct()

interaction_list <- list()



for (ide in test_unique) {
df_id_time <- test_graph[test_graph$from == ide | test_graph$to == ide, ]
interaction_list[[paste0("int_", ide)]] <- df_id_time
}


data_nuit <- data  %>%
  filter(hour(data$date_posix) <= hour_thresold) %>%
  filter(length >= length_thresold)

```

```{r}
#####data %>% filter(id == "PA-001-LAM") %>% filter(date_posix <= begin_date )
```

