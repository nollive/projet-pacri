---
title: "visualization-nodscov2"
author: "Olivier GAUFRÃˆS"
date: "2024-05-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(lubridate)
```

```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)
cpp_path <-  file.path(wd,"..", "..", "cpp")
cpp_model_path <- file.path(cpp_path,"nodscov2")
sim_nodscov2_path <- file.path(wd, "..", "..", "out", "sim-nodscov2")
```

```{r}
id_sim <- "01"
load(file.path(sim_nodscov2_path, paste0(id_sim, "-", "simulation-nodscov2.RData")))
```

## Vizualisation
```{r}
## Number of infected over time
counts <- sapply(1:n_subdivisions, function(t) {
  sum(data_sim[["global_status"]]$t_inf <= t &
        data_sim[["global_status"]]$t_recover >= t &
        data_sim[["global_status"]]$t_inf != -1)
})

infected_over_time <- data.frame(time = 1:n_subdivisions, infected_count = counts)

ggplot(infected_over_time, aes(x = time * 30 + begin_date, y = infected_count)) +
  geom_line(color = "blue") +
  labs(title = "Number of Infected Individuals Over Time",
       x = "Time",
       y = "Number of Infected Individuals") +
  theme_bw()+
  theme(axis.text.x=element_text(angle=45, hjust=1))

```

## Viral load
```{r}
viral_load_over_time <- do.call(rbind, lapply(1:length(data_sim[["global_environment"]]), function(t) {
  data.frame(time = begin_date + 30 * t,
             room = data_sim[["global_environment"]][[t]]$room,
             viral_load = data_sim[["global_environment"]][[t]]$env)
}))

ggplot(viral_load_over_time, aes(x = time, y = viral_load, color = factor(room))) +
  geom_line() +
  labs(title = "Viral Load in Rooms Over Time",
       x = "Time",
       y = "Viral Load",
       color = "Room") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, hjust=1))
```


## FOI
```{r}
hcw_id <- admission %>% filter(status == "PE") %>% pull(id)


FOI_over_time <- do.call(rbind, lapply(1:length(data_sim[["global_lambda"]]), function(t) {
  data.frame(time = begin_date + 30 * t,
             id = data_sim[["global_lambda"]][[t]]$id,
             lambda_e = data_sim[["global_lambda"]][[t]]$lambda_e,
             lambda_c = data_sim[["global_lambda"]][[t]]$lambda_c,
             status = ifelse(data_sim[["global_lambda"]][[t]]$id %in% hcw_id, "PE", "PA"))
}))

ggplot(FOI_over_time, aes(x = time)) +
  geom_line(aes(y = lambda_e, colour = "lambda_e (environment)" ), alpha = 0.5) +
  geom_line(aes(y = lambda_c, colour = "lambda_c (close-contact)" ), alpha = 0.5) +
  labs(title = "Lambda Over Time",
       x = "Time",
       y = "Lambda",
       color = "Lambda") +
  facet_grid(cols = vars(status)) + 
  theme_bw() + 
  theme(axis.text.x=element_text(angle=45, hjust=1))
```


```{r}
FOI_over_time <- FOI_over_time %>% mutate(p_inf = 1 - exp(-lambda_e - lambda_c))

ggplot(FOI_over_time, aes(x = time)) +
  geom_line(aes(y = lambda_e, colour = "P_inf" )) +
  labs(title = "Probability of infection Over Time",
       x = "Time",
       y = "P_inf",
       color = "P_inf") +
  facet_grid(cols = vars(status)) + 
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, hjust=1))

```



## INFECTION CHAIN
```{r}
library(epicontacts)
id_index <- data_sim[["global_status"]] %>% filter(inf_by == "INDEX") %>% pull(id)
## linelist object
linelist <- left_join(admission_sim, data_sim[["global_status"]], by = join_by(id))
linelist <- linelist %>%
  mutate(type = ifelse(info == 0, "PATIENT", "HEALTHCARE WORKER")) %>%
  mutate(type = ifelse(id == id_index, "INDEX", type)) 

env_linelist <- data.frame(id = paste0("ENVIRONMENT-",rooms %>% distinct(id_room, .keep_all = TRUE) %>% pull(id_room)),
                           type = "ROOM",
                           room = rooms %>% distinct(id_room, .keep_all = TRUE) %>% pull(id_room))

linelist <- bind_rows(linelist,env_linelist)


## contacts object
environmental_contacts <- data_sim[["global_status"]] %>%
  filter(grepl("ENVIRONMENT", inf_by)) %>%
  mutate(from = inf_by, to = id, time = t_inf) %>%
  mutate(cause = "ENVIRONMENT") %>% 
  select(from, to, t_inf, t_recover, inf_by, cause)


close_contacts <- data_sim[["global_status"]] %>%
  filter(grepl("CONTACT", inf_by)) %>%
  mutate(from = gsub("CONTACT-", "", inf_by), to = id, time = t_inf) %>%
  mutate(cause = "CONTACT") %>% 
  
  select(from, to, t_inf, t_recover, inf_by, cause)

inf_contacts_df <- bind_rows(environmental_contacts, close_contacts)
inf_contacts_df <- inf_contacts_df %>% mutate(inf_interval = paste0("{",t_inf,";", t_recover,"}"))


## epicontacts object
x <- make_epicontacts(linelist = linelist,
                      contacts = inf_contacts_df,
                      id = "id",
                      from = "from",
                      to = "to",
                      directed = FALSE)

## plot epicontacts
vis_epicontacts(x,
                node_color = "type",
                edge_color = "cause",
                col_pal =  cases_pal,
                # edge_col_pal = spectral,
                #edge_label = "inf_interval",
                label = "room",
                node_shape = "type",
                shape = c(INDEX = "circle", `HEALTHCARE WORKER` = "circle", PATIENT = "circle", ROOM= "bed"),
                thin = TRUE,
                selector = TRUE,
                )

### NOT WORKING
#node_colors <- setNames(c("red", "blue", "black","darkgreen"), c("PATIENT", "HEALTHCARE WORKER", "INDEX","ROOM"))
# custom_palette <- c("INDEX" = "#2ca02c", "PATIENT" = "#d62728", "HEALTHCARE WORKER" = "#1f77b4", "ROOM" = "#ff7f0e")
# linelist$color <- fac2col(linelist$type, pal = function(n) custom_palette)
```
