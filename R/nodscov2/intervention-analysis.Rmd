---
title: 'intervention-analysis'
author: 'Olivier GAUFRÃˆS'
date: '2024-07-30'
output: html_document
---

```{r}
## LIBRARIES
library(dplyr)
library(tidyr)
library(purrr)
library(data.table)




```


```{r}
##PATHS
wd <- getwd()

source(file.path(wd, 'intervention-analysis_fun.R'))
out_path <- file.path(wd,'..','..', 'out')
loc_path <- file.path(out_path,'loc-nodscov2')
intervention_path <- file.path(out_path, 'intervention-analysis')
```

## LOAD LOCALIZATION DATA & GLOBAL PARAMETERS
```{r}
load(file.path(loc_path, 'dev-localization-nodscov2.RData'))
load(file.path(intervention_path, "parameters-admission-nodscov2.RData"))

##TO FIX IN loc-to-RData (rerun to update parameters.RData)
admission <- admission %>% filter(id %in% admission_sim$id)
```

## ADJUST THE BEGIN/END DATES OF SIMULATIONS
```{r}
new_begin_date <- begin_date + t_begin*30 ## OFFSET TO START THE DAY AT 12AM
new_end_date <- new_begin_date + new_n_subdivisions*30
print(new_end_date - new_begin_date)
```
## BETA/NU COUPLES -> READ SIMULATION RESULTS
```{r}
#read_all_files <- function(path, )

## ALL COUPLES INSIDE A LIST, EVERY SIMULATION INSIDE SUB-LIST NAMED sim<beta>_<nu> --> WILL BE NAMED A COUPLE
list_dirs <- list.dirs(path = file.path(intervention_path, 'out'), recursive = F, full.names = F)
list_sim <- list()

## READ ALL SIMULATION FOR ALL AVAILABLE COUPLES
for (dir in list_dirs){
  list_sim[[dir]] <- list()
  sim_path <- file.path(intervention_path, 'out', dir, 'results')
  rdata_files <- list.files(sim_path, pattern = "^sim_.*\\.RData$", full.names = F)
  invisible(lapply(rdata_files, function(file) load_rdata_to_list(file, list_sim, dir)))
}
```

## FOR EACH SIMULATION -> COMPUTE SAR
```{r}
## CATEGORY GROUPING INTO TYPE
cat_paramedical <- c("nurse", "student nurse", "aux nurse")
cat_medical <- c("physician", "ext physician", "reeducation staff", "other")

## IDS BY CATEGORY
id_patient <- admission_sim %>% filter(info == 0) %>% distinct(id) %>% pull()
id_hcw <- admission_sim %>% filter(info == 1) %>% distinct(id) %>% pull()
## FOR MEDICAL/PARAMEDICAL WE USE ADMISSION (INDIVIDUALS BEFORE ADDING NEW PATIENTS)
id_paramedical <- admission %>% filter(cat %in% cat_paramedical) %>% distinct(id) %>% pull()
id_medical <- admission %>% filter(cat %in% cat_medical) %>% distinct(id) %>% pull()

## GET SARs FOR ALL COUPLES
list_SAR <- get_all_SAR(list_sim = list_sim, 
                        id_patient = id_patient, 
                        id_hcw = id_hcw, 
                        id_paramedical = id_paramedical, 
                        id_medical = id_medical)

```

## SAR METRICS
```{r}
all_SAR_metrics <- get_all_SAR_metrics(list_SAR = list_SAR)

##SELECT COUPLES FOR SAR +/- 20%
all_SAR_metrics %>% filter(dplyr::between(SAR_median, 0.10, 0.30))
all_SAR_metrics %>% filter(dplyr::between(SAR_mean, 0.15, 0.25))
```

## SAR_distribution  
```{r}
get_SAR_distribution <- function(couple, list_SAR){
  SAR_distrib <- rbindlist(list_SAR[[couple]], idcol = 'id_sim')  %>% group_by(id_sim)
  return(SAR_distrib)
}
get_SAR_distribution(couple, list_SAR)
```

## EPIDEMIC DURATION
```{r}
list_epidemic_duration <- get_all_epidemic_duration(list_sim = list_sim)
all_epidemic_duration_metrics <- get_all_epidemic_duration_metrics(list_epidemic_duration = list_epidemic_duration)
```

## MAX N INFECTIOUS AT PEAK




## ALL METRICS IN ONE DF
```{r}
all_metrics <- left_join(all_SAR_metrics, all_epidemic_duration_metrics, by="couple", suffix=c("",".y")) %>%
  select(-ends_with(".y"))
```



## SEIR
```{r}
id_global <- global_status %>% distinct(id) %>% pull()
n_individual <- length(id_global)


list_SEIR <- list()

for(couple in names(list_sim)){
  parts <- strsplit(couple, "_")[[1]]
  beta <- eval(parse(text = gsub(pattern = '-', replacement = '/', x = parts[2])))
  nu <- eval(parse(text = gsub(pattern = '-', replacement = '/', x = parts[3])))
  
  list_SEIR[[couple]] <- SEIR_to_list(sim_list = list_sim[[couple]], n_subdivisions = new_n_subdivisions, n_individual = n_individual)

}



```



```{r}
fig_path <- file.path(intervention_path, id_sim, paste0(id_sim,"-fig"))

if (!dir.exists(fig_path)) {
  dir.create(fig_path, recursive = TRUE)
}
```

