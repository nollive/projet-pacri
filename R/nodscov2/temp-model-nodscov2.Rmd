---
title: "temp-model-nodscov2"
author: "Olivier GAUFRÈS"
date: "2024-05-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
#library(tidyverse)
library(ggplot2)
library(lubridate)
```

```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)

data_path <- file.path(wd,"..", "..", "data")
nodscov2_path <- file.path(data_path, "data-nodscov2") 
```

### WIP 

## NodsCov2 data (not shared)
```{r}
load("Y:/ogaufres/pacri-non-sync/data/data-nodscov2/admission_ctc_nodscov2.RData")
load("Y:/ogaufres/pacri-non-sync/data/data-nodscov2/list_ward.RData")
load(file.path(wd,"localization-nodscov2.RData")) ##overwrite admission
```

## FIXING ENCODING
```{r}
Encoding(admission$hospital) <- 'latin1'
```

```{r}
## FILTER THE DATAFRAMES
list_ward <- lapply(list_ward, function(x) {
  ## FILTER INTERACTIONS TO KEEP ONLY HCW AND PATIENTS
  x <- x%>% filter(from %in% admission$id & to %in% admission$id)
  ## ADD INFO OF THE STATUS FOR INDIVIDUALS
  x <- left_join(x, admission %>% select(id, status), by = c("from" = "id")) %>%
    rename(from_status = status) %>%
    left_join(admission %>% select(id, status), by = c("to" = "id")) %>%
    rename(to_status = status)
})

data <- list_ward[["Raymond_Poincare-Reanimation-20200506-20200507"]]

# admission <- admission %>%
#   filter(ward == "Reanimation") %>% 
#   filter(hospital == "APHP - RAYMOND POINCARÉ") %>%
#   filter(!(cat %in% c("administration",
#                   "investigation",
#                   "logistic",
#                   "visitor"))) %>%
#   ## ADD PE/PA IN ADMISSION'S IDs (id)
#   mutate(id_bis = paste0(status,"-",id))
```

## TEMPORARY
```{r}
## plans are more detailled for Raymond Poincaré hospital
## Dimensions

begin_date
end_date

time_spent <- end_date - begin_date
time_spent

n_subdivisions

n_individuals <- as.integer(admission %>%
                              filter(hospital == "APHP - RAYMOND POINCARÉ", ward == "Reanimation") %>%
                              distinct(id) %>%
                              count())
n_individuals

# begin_date <- as.POSIXct(min(data$date_posix_first))
# end_date <- as.POSIXct(max(data$date_posix_first + data$length))

# 
# 
# n_subdivisions <- as.integer(time_spent) * 24 * 60 * 2 ## Time spent * hours * minutes * 2 (number of time subdivisions)



```

## ROOMS
```{r}
## LOADED WITH .RData (localisation-nodscov2.Rmd)
rooms

# rooms <- admission %>%
#   filter(status == "PA") %>%
#   distinct(id) %>%
#   mutate(room = as.factor(row_number())) %>%
#   mutate(id_room = as.factor(row_number())) %>%
#   select(id_room,room, id)
# 
# rooms <- rooms %>%
#   bind_rows(data.frame(room = "Restroom", id = "PE", id_room = as.factor(nrow(rooms) + 1))) %>%
#   bind_rows(data.frame(room = "Corridor", id = "ALL", id_room = as.factor(nrow(rooms) + 2)))
# 
# ### DOUBLE ROOMS
# ## "001-0038-B-S" and = "001-0039-B-F" are in the same room
# ## "001-0127-B-A" and "001-0128-Z-K" are in the same room
# rooms <-rooms %>% mutate(room = ifelse(id == "001-0038-B-S", rooms[rooms$id == "001-0039-B-F", "room"], room),
#                          id_room = ifelse(id == "001-0038-B-S", rooms[rooms$id == "001-0039-B-F", "id_room"], id_room))
# 
# rooms <-rooms %>% mutate(room = ifelse(id == "001-0128-Z-K", rooms[rooms$id == "001-0127-B-A", "room"], room),
#                          id_room = ifelse(id == "001-0128-Z-K", rooms[rooms$id == "001-0127-B-A", "id_room"], id_room))
# 
double_rooms <- list(c("001-0038-B-S", "001-0039-B-F"), c("001-0127-B-A", "001-0128-Z-K"))
```

## ENVIRONMENT
```{r}
env_t <- rooms %>%
  distinct(room) %>%
  mutate(env = 0) %>%
  mutate(id_room = rooms %>% distinct(id_room) %>% pull() ) %>%
  select(room, id_room, env)

global_environment <- lapply(1:n_subdivisions, function(t){
  return (env_t)
})

rm(env_t)
```

## LOCALISATION
```{r}
## LOADED WITH .RData (localization-nodscov2.Rmd)
head(global_localization)
```

## STATUS
```{r}
status_t <- admission %>%
  distinct(id) %>%
  mutate(status = 0)

global_status <- lapply(1:n_subdivisions, function(t){
  return(status_t)
})
rm(status_t)
```


## GLOBAL DATABASE
```{r}
## global_localization
## global_environment
## global_status

## infered_admission
## HCW_interacting_id

## begin_date
## end_date
## n_subdivisions
```











<!-- ################################# GARBAGE ############################## -->





