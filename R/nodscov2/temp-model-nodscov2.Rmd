---
title: "temp-model-nodscov2"
author: "Olivier GAUFRÈS"
date: "2024-05-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
#library(tidyverse)
library(ggplot2)
library(lubridate)
library(Rcpp)
library(RcppParallel)
```

```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)

data_path <- file.path(wd,"..", "..", "data")
nodscov2_path <- file.path(data_path, "data-nodscov2")
cpp_path <-  file.path(wd,"..", "..", "cpp")
cpp_model_path <- file.path(cpp_path,"nodscov2")
```

### WIP 

## NodsCov2 data (not shared)
```{r}
load("Y:/ogaufres/pacri-non-sync/data/data-nodscov2/admission_ctc_nodscov2.RData")
load("Y:/ogaufres/pacri-non-sync/data/data-nodscov2/list_ward.RData")
load(file.path(wd,"localization-nodscov2.RData")) ##overwrite admission
```

## FIXING ENCODING
```{r}
Encoding(admission$hospital) <- 'latin1'
```

```{r}
## FILTER THE DATAFRAMES
list_ward <- lapply(list_ward, function(x) {
  ## FILTER INTERACTIONS TO KEEP ONLY HCW AND PATIENTS
  x <- x%>% filter(from %in% admission$id & to %in% admission$id)
  ## ADD INFO OF THE STATUS FOR INDIVIDUALS
  x <- left_join(x, admission %>% select(id, status), by = c("from" = "id")) %>%
    rename(from_status = status) %>%
    left_join(admission %>% select(id, status), by = c("to" = "id")) %>%
    rename(to_status = status)
})

data <- list_ward[["Raymond_Poincare-Reanimation-20200506-20200507"]]

# admission <- admission %>%
#   filter(ward == "Reanimation") %>% 
#   filter(hospital == "APHP - RAYMOND POINCARÉ") %>%
#   filter(!(cat %in% c("administration",
#                   "investigation",
#                   "logistic",
#                   "visitor"))) %>%
#   ## ADD PE/PA IN ADMISSION'S IDs (id)
#   mutate(id_bis = paste0(status,"-",id))
```

## TEMPORARY
```{r}
## plans are more detailled for Raymond Poincaré hospital
## Dimensions
begin_date
end_date
time_spent <- end_date - begin_date
time_spent
n_subdivisions
n_individuals <- as.integer(admission %>%
                              filter(hospital == "APHP - RAYMOND POINCARÉ", ward == "Reanimation") %>%
                              distinct(id) %>%
                              count())
n_individuals
# begin_date <- as.POSIXct(min(data$date_posix_first))
# end_date <- as.POSIXct(max(data$date_posix_first + data$length))
# n_subdivisions <- as.integer(time_spent) * 24 * 60 * 2 ## Time spent * hours * minutes * 2 (number of time subdivisions)
```

## INTERACTIONS
```{r}
global_interaction <- data_list
```

## ROOMS
```{r}
## LOADED WITH .RData (localisation-nodscov2.Rmd)
rooms

# rooms <- admission %>%
#   filter(status == "PA") %>%
#   distinct(id) %>%
#   mutate(room = as.factor(row_number())) %>%
#   mutate(id_room = as.factor(row_number())) %>%
#   select(id_room,room, id)
# 
# rooms <- rooms %>%
#   bind_rows(data.frame(room = "Restroom", id = "PE", id_room = as.factor(nrow(rooms) + 1))) %>%
#   bind_rows(data.frame(room = "Corridor", id = "ALL", id_room = as.factor(nrow(rooms) + 2)))
# 
# ### DOUBLE ROOMS
# ## "001-0038-B-S" and = "001-0039-B-F" are in the same room
# ## "001-0127-B-A" and "001-0128-Z-K" are in the same room
# rooms <-rooms %>% mutate(room = ifelse(id == "001-0038-B-S", rooms[rooms$id == "001-0039-B-F", "room"], room),
#                          id_room = ifelse(id == "001-0038-B-S", rooms[rooms$id == "001-0039-B-F", "id_room"], id_room))
# 
# rooms <-rooms %>% mutate(room = ifelse(id == "001-0128-Z-K", rooms[rooms$id == "001-0127-B-A", "room"], room),
#                          id_room = ifelse(id == "001-0128-Z-K", rooms[rooms$id == "001-0127-B-A", "id_room"], id_room))
# 
double_rooms <- list(c("001-0038-B-S", "001-0039-B-F"), c("001-0127-B-A", "001-0128-Z-K"))
```

## ENVIRONMENT
```{r}
env_t <- rooms %>%
  distinct(room) %>%
  mutate(env = 0) %>%
  mutate(id_room = rooms %>% distinct(id_room) %>% pull() ) %>%
  select(room, id_room, env)
env_t$id_room <- as.integer(env_t$id_room)

global_environment <- lapply(1:n_subdivisions, function(t){
  return (env_t)
})

rm(env_t)
```

## LOCALISATION
```{r}
## LOADED WITH .RData (localization-nodscov2.Rmd)
head(global_localization)

## REMOVE "NOT HERE" FROM global_localization[[t]]$localization (in order to have an integer vector)
global_localization <- lapply( 1:n_subdivisions, function(t){
  loc_t <- global_localization[[t]]
  loc_t <- loc_t %>% mutate(localization = ifelse(localization == "NOT HERE", -1, localization))
  loc_t$localization <- as.integer(loc_t$localization)
  return(loc_t)
})



```

## STATUS
```{r}
status_t <- admission %>%
  distinct(id) %>%
  mutate(status = 0)

global_status <- lapply(1:n_subdivisions, function(t){
  return(status_t)
})
rm(status_t)
```


## LAMBDA
```{r}
lambda_t <- admission %>%
  distinct(id) %>%
  mutate(lambda_c = 0, lambda_e = 0)
global_lambda <- lapply(1:n_subdivisions, function(t){
  return(lambda_t)
})
rm(lambda_t)
```
## INFO_PATIENT_HCW
```{r}
admission_test <- admission %>%
  mutate(info = ifelse(status == "PE", 1,0)) %>%
  select(id,info) %>%
  mutate(id_ind = id) %>% 
  left_join(rooms, by = c("id_ind" = "id")) %>%
  mutate(room = ifelse(info == 1, rooms[rooms$id == "PE", "id_room"], room)) %>%
  select(id,info,room)
admission_test$info <- as.integer(admission_test$info)
admission_test$room <- as.integer(admission_test$room)

```


## GLOBAL DATABASE
```{r}
## global_interaction
## global_localization
## global_environment
## global_status
## global_lambda


## inferred_admission (if needed?)
## HCW_interacting_id (if needed?)
## double_rooms (if needed?)


## begin_date (if needed?)
## end_date (if needed?)
## n_subdivisions

## clusters (if needed?)
```




```{r}
beta = 1
epsilon = 1
mu = 1
nu = 1
dt = 30
t = 3


sourceCpp(file.path(cpp_model_path,"model_nodscov2.cpp"))
t=1
ta = Sys.time()
for (t in 2:n_subdivisions){
  lambda <- global_lambda[[t]]
  status <- global_status[[t]]
  int <- global_interaction[[t]]
  loc <- global_localization[[t]]
  env <- global_environment[[t]]
  env_tm1 <- global_environment[[t-1]]
  loc_tm1 <- global_localization[[t-1]]
  status_tm1 <- global_status[[t-1]]
  lambda_tm1 <- global_lambda[[t-1]]
  loc_tm1 <- global_localization[[t-1]]
  id = "001-0007-J-I"
  a <- List_encountered(id, int)
  b = Lambda_c(lambda_tm1, int, status, beta, dt)
  c = Lambda_e(lambda_tm1,  loc, env, admission_test, epsilon, dt)
  d = Get_t(global_localization,t)
  e = Update_environment(env_tm1, loc_tm1, status_tm1, admission_test, mu, nu, dt )
  setdiff(d,global_localization[[t]])
}
tb = Sys.time()
print(tb-ta)





```




<!-- ################################# GARBAGE ############################## -->





