---
title: "Interaction-nodscov2"
author: "Olivier GAUFRÈS"
date: "2024-05-03"
output: html_document
---

## Libraries
```{r setup, include=TRUE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lubridate)
library(tidyr)
library(viridis)
library(purrr)
rm(list = ls())

# Source functions, dictionaries and helpful variables
source("helper-functions.R")
source("scenarios-figures-supp.R")

# Working directories and paths
data_path = file.path("..", "..", "data")
nodscov2_path = file.path("..", "..", "data", "data-nodscov2") 
synthetic_path = file.path("..", "..", "data", "data-synthetic-graphs")
```

## NodsCov2 data (not shared)
```{r load data, echo=FALSE}
# Admission dates
load(file.path(nodscov2_path, "admission_ctc_nodscov2.RData"))
Encoding(admission$hospital) <- 'latin1'

# Interactions 
list_ward = read.csv(file.path(nodscov2_path, "list_ward_complete.csv"))

# Sensor distribution 
sensor = read.csv(file.path(nodscov2_path, "met_timespent_mins_complete.csv"))
```

## Initial composition of Raymond Poincaré ICU
```{r initial composition}
# Number of participants
# Investigation staff are excluded as they were part of the staff deploying the sensors
# and do not belong to the medical wards per se
admission %>%
  filter(hospital == "APHP - RAYMOND POINCARÉ", ward == "Reanimation", !cat %in% "investigation") %>%
  distinct(id) %>%
  nrow()

# Number of participants by individual category
admission %>%
  filter(hospital == "APHP - RAYMOND POINCARÉ", ward == "Reanimation", !cat %in% "investigation") %>%
  group_by(status, cat) %>%
  summarize(n = n(), .groups = "drop")

```

## Create input dataframes for the synthetic network algorithm 
```{r synthetic data}
# Create dataframe with admission dates for the synthetic network algorithm
admission_nodscov2 = admission %>%
  filter(
    hospital == "APHP - RAYMOND POINCARÉ", 
    ward == "Reanimation",
    cat %in% c(cat_medical, cat_paramedical) | is.na(cat)
    ) %>%
  mutate(cat = recode(cat, !!!dict_cat)) %>%
  mutate(cat = ifelse(is.na(cat), "Patient", cat)) %>%
  select(-hospital)
nrow(admission_nodscov2)

# Sensor distribution data 
# Keep individuals from the ICU of Raymond Poincaré
# Keep individuals that have a sensor between noon on the 1st day and noon on the 2nd day 
sensor_nodscov2 = sensor %>%
  mutate(
    DATEREMISEJ1 = as_datetime(DATEREMISEJ1),
    DATERECJ1 = as_datetime(DATERECJ1),
    DATEREMISEJ2 = as_datetime(DATEREMISEJ2),
    DATERECJ2 = as_datetime(DATERECJ2),
    J1 = as_datetime(J1),
    N1 = as_datetime(N1),
    J2 = as_datetime(J2),
    N2 = as_datetime(N2),
    firstDate_sensor = as.Date(cut(DATEREMISEJ1, "day")), 
    lastDate_sensor = as.Date(case_when(is.na(DATERECJ2) ~ cut(DATERECJ1, "day"), .default = cut(DATERECJ2, "day")))
  ) %>%
  select(id, DATEREMISEJ1, DATERECJ1, DATEREMISEJ2, DATERECJ2) %>%
  pivot_longer(-id, names_to = c(".value", "Day"), names_sep = "J") %>% 
  rename(firstDate_sensor = DATEREMISE, lastDate_sensor = DATEREC) %>%
  mutate(ward = "Reanimation") %>%
  inner_join(., admission_nodscov2 %>% select(id, status, cat), by = "id") %>%
  select(id, status, cat, ward, firstDate_sensor, lastDate_sensor) %>%
  filter(!(lastDate_sensor <= noon_day1 | firstDate_sensor >= noon_day2)) %>%
  mutate(
    firstDate_sensor = case_when(firstDate_sensor <= noon_day1 ~ noon_day1, .default = firstDate_sensor),
    lastDate_sensor = case_when(lastDate_sensor >= noon_day2 ~ noon_day2, .default = lastDate_sensor)
  )
length(unique(admission_nodscov2$id)) - length(unique(sensor_nodscov2$id)) # Individuals with no sensor during the 24hours

# Interaction data from Raymond Poincaré
interaction_nodscov2 = list_ward %>%
  mutate(date_posix_first = as_datetime(date_posix_first)) %>%
  filter(
    # Raymond Poincaré ICU
    newID == "Medical ICU #1",
    # Only categories of interest
    from %in% sensor_nodscov2$id, to %in% sensor_nodscov2$id,
    # Interactions that occur before or after the 24 hour period
    !(date_posix_first+length <= noon_day1 | date_posix_first >= noon_day2)
    )

interaction_first_last = interaction_nodscov2 %>%
  mutate(date_day = as.Date(floor_date(date_posix_first, "day")),
         date_day_end = as.Date(floor_date(date_posix_first+length, "day"))) %>%
  pivot_longer(cols = c(from, to), values_to = "id") %>%
  group_by(id) %>%
  summarise(firstDate_interaction = min(date_day), lastDate_interaction = max(date_day_end))

# Compare first date and last date in the admission data, sensor distribution data 
# and interaction data
admission_nodscov2 %>%
  left_join(., sensor_nodscov2 %>% select(id, firstDate_sensor, lastDate_sensor) %>% group_by(id) %>% summarise(firstDate_sensor = min(firstDate_sensor), lastDate_sensor = max(lastDate_sensor), .groups = "drop"), by = "id") %>%
  left_join(., interaction_first_last, by = "id") %>%
  mutate(firstDate_sensor = as.Date(firstDate_sensor)) %>%
  filter(firstDate_sensor > firstDate_interaction) %>%
  select(id, firstDate, firstDate_sensor, firstDate_interaction)

admission_nodscov2 %>%
  left_join(., sensor_nodscov2 %>% select(id, firstDate_sensor, lastDate_sensor) %>% group_by(id) %>% summarise(firstDate_sensor = min(firstDate_sensor), lastDate_sensor = max(lastDate_sensor), .groups = "drop"), by = "id") %>%
  left_join(., interaction_first_last, by = "id") %>%
  mutate(lastDate_sensor = as.Date(lastDate_sensor)) %>%
  filter(lastDate_sensor < lastDate_interaction) %>%
  select(id, lastDate, lastDate_sensor, lastDate_interaction)

# Use sensor distribution data for the first and last date in admission
admission_nodscov2 = admission_nodscov2 %>%
  select(-c(firstDate, lastDate)) %>%
  inner_join(., sensor_nodscov2 %>% 
               select(id, firstDate_sensor, lastDate_sensor) %>%
               group_by(id) %>%
               summarise(firstDate_sensor = min(firstDate_sensor), 
                         lastDate_sensor = max(lastDate_sensor), 
                         .groups = "drop"), 
             by = "id") %>%
  rename(firstDate = firstDate_sensor, lastDate = lastDate_sensor) %>%
  select(id, status, firstDate, lastDate, ward, sex, hospitalization, cat)

# Trim data to keep only 24 hours of interactions
interaction_nodscov2 = interaction_nodscov2 %>%
  mutate(
    length = case_when(
      date_posix_first <= noon_day1 ~ as.numeric(date_posix_first+length - noon_day1),
      date_posix_first+length >= noon_day2 ~ as.numeric(noon_day2 - date_posix_first),
      .default = length 
    ),
    date_posix_first = case_when(
      date_posix_first <= noon_day1 ~ noon_day1,
      .default = date_posix_first
    )
  )

# Verify that we have the same participants in all three databases
identical(
  sort(unique(admission_nodscov2$id)),
  sort(unique(sensor_nodscov2$id))
)
all(c(interaction_nodscov2$from, interaction_nodscov2$to) %in% admission_nodscov2$id)

# Agenda of healthcare workers
agenda_nodscov2 = sensor_nodscov2 %>%
  rename(firstDate = firstDate_sensor, lastDate = lastDate_sensor) %>%
  filter(status != "PA")

# Number of participants by category retained from the real data
admission_nodscov2 %>%
  group_by(status, cat) %>%
  summarise(n = n(), .groups = "drop")

# Individuals with no interaction when wearing the sensor 
admission_nodscov2 %>% 
  filter(!id %in% c(interaction_nodscov2$from, interaction_nodscov2$to)) %>%
  group_by(status, cat) %>%
  summarise(n = n(), .groups = "drop")

```

## Frequency of contacts of more than one hour
```{r file for synthetic data algo}
# Frequency of contacts that last more than 1hour
interaction_nodscov2 %>%
  summarise(
    n = n(), 
    n_more_1h = sum(length/3600 >= 1),
    p = sum(length/3600 >= 1) / n() * 100
    )

# Distribution of contact duration for contacts lasting more than 1h
interaction_nodscov2 %>%
  filter(length >= 3600) %>%
  mutate(length = length/3600) %>%
  select(length) %>%
  summary()
```

## Contact recurrence probability 
```{r contact recurrence by hour}
# Hourly individual probability of recurring contacts and mean individual
# probability
pind = rep(NA, nrow(admission_nodscov2))
for (i in seq_along(admission_nodscov2$id)) {
  ii = admission_nodscov2$id[i]
  
  # Get n hours spent in the ward with a sensor 
  all_h = sensor_nodscov2 %>%
    filter(id == ii) %>%
    mutate(DATEREMISE = floor_date(firstDate_sensor, "hour"), DATEREC = floor_date(lastDate_sensor, "hour"), k = 1:n()) %>%
    arrange(DATEREMISE) %>%
    group_by(k) %>%
    nest() %>%
    mutate(out = map(data, unroll_dates)) %>%
    unnest(out) %>%
    .$date_list
    
  if (length(all_h) > 1) {
    interaction_h = vector("list", length(all_h))
    proba_h = rep(NA, length(all_h)-1)
    
    # Get lists of contacts per hour
    for (h in seq_along(all_h)) {
      hh = all_h[h]
      contacts = interaction_nodscov2 %>%
        filter(from == ii | to == ii, date_posix_first >= hh, date_posix_first < hh+3600) %>%
        select(from, to) %>%
        unlist()
      contacts = unique(contacts[contacts != ii])
      names(contacts) = NULL
      interaction_h[[h]] = contacts 
    }
    
    # Get hourly probability of recurring contacts
    if (length(all_h)>1) {
      for (h in 2:length(all_h)) {
        if (length(interaction_h[[h]]) > 0) {
          proba_h[h-1] = sum(interaction_h[[h]] %in% unlist(interaction_h[1:(h-1)])) / length(interaction_h[[h]])
        } else {
          proba_h[h-1] = 0
        }
      }
    }
    
    # Mean individual hourly probability of recurring contacts
    pind[i] = sum(proba_h) / length(proba_h)
    
  } else {
    pind[i] = 0
  }

}

# Plot mean individual probability of recurring contacts
admission_nodscov2 %>%
  mutate(pind = pind) %>%
  ggplot(., aes(x = cat, y = pind)) +
  geom_boxplot() +
  geom_jitter() +
  theme_bw() +
  labs(x = "", y = "Probability of hourly recurring contact")

# Mean probability of recurring contacts by individual category
admission_nodscov2 %>%
  mutate(pind = pind) %>%
  group_by(cat) %>%
  summarise(m = mean(pind), .groups = "drop")

# Comparison by category of individual
admission_nodscov2 %>%
  mutate(pind = pind) %>%
  rstatix::wilcox_test(pind ~ cat, ref.group = "Paramedical")

# Mean probability when aggregating paramedical and medical staff
admission_nodscov2 %>%
  mutate(pind = pind, cat = ifelse(cat == "Patient", cat, "HCW")) %>%
  group_by(cat) %>%
  summarise(m = mean(pind), .groups = "drop")
```


## Patient augmentation
```{r patient augmentation}
# Double rooms - Cumulative time
patients_ids = unique(admission_nodscov2$id[admission_nodscov2$status == "PA"])
interaction_nodscov2 %>% 
  filter(from %in% patients_ids, to %in% patients_ids) %>%
  mutate(pair = paste0(from, "_", to)) %>%
  group_by(pair) %>%
  summarise(length = sum(length)/3600, .groups = "drop")

# List of ids in double rooms
double_rooms = interaction_nodscov2 %>%
  filter(from %in% patients_ids, to %in% patients_ids) %>%
  distinct(from, to)
double_rooms = as.list(as.data.frame(t(double_rooms)))

# Patient rooms
patient_rooms = data.frame(
  id = admission_nodscov2$id[admission_nodscov2$status == "PA"],
  room = 1:sum(admission_nodscov2$status == "PA")
)
patient_rooms$room[patient_rooms$id %in% double_rooms[[1]]] = min(patient_rooms$room[patient_rooms$id %in% double_rooms[[1]]])

# Patient augmentation
set.seed(20240924)
for (id in patients_ids) {
  
  # Stay length of original individual
  if (as.Date(floor_date(admission_nodscov2$lastDate[admission_nodscov2$id == id])) == as.Date("2020-05-07")) {
    stay_length = sample(6:13, 1)
    new_lastDate = as_datetime("2020-05-06 12:00:00") + stay_length*3600*24
    admission_nodscov2$lastDate[admission_nodscov2$id == id] = new_lastDate
  } else {
    new_lastDate = as_datetime("2020-05-06 12:00:00")
  }
  
  # Augment patients by keeping the incrementing the original id
  i = 1
  new_room = data.frame()
  while(new_lastDate < noon_last_day) {
    stay_length = sample(6:13, 1)
    to_rbind = data.frame(
      id = paste0(id, "-", i),
      status = "PA",
      firstDate = new_lastDate,
      lastDate = min(new_lastDate+stay_length*3600*24, noon_last_day),
      ward = "Reanimation",
      sex = NA,
      hospitalization = "patient",
      cat = "Patient"
    )  
    
    patient_rooms = rbind(
      patient_rooms, 
      data.frame(
        id = paste0(id, "-", i),
        room = patient_rooms$room[patient_rooms$id == id]
      )
    )
    
    admission_nodscov2 = rbind(admission_nodscov2, to_rbind)
    new_lastDate = min(new_lastDate+stay_length*3600*24, noon_last_day)
    i = i+1
  }
}

# Final set of individuals in the database
admission_nodscov2 %>%
  group_by(status, cat) %>%
  summarise(n = n(), .groups = "drop") 
```

## Repeat schedule of HCWs over the 90-day period
```{r repeat schedule}
# Repeat schedule over 90 days
new_agenda = agenda_nodscov2
for (d in 1:90) {
  new_agenda = rbind(new_agenda, agenda_nodscov2 %>% mutate(firstDate = firstDate+3600*24*d,
                                                            lastDate = lastDate+3600*24*d))
}
new_agenda = new_agenda %>%
  filter(lastDate <= noon_last_day)

# Get new admission dates for HCWs
new_admission_dates = new_agenda %>%
  group_by(id) %>%
  summarise(firstDate_new = as.Date(cut.POSIXt(min(firstDate), "day")),
            lastDate_new = as.Date(cut.POSIXt(max(lastDate), "day")),
            .groups = "drop")

# Verify coherence and change admission dates for HCWs
# admission_nodscov2 %>%
#   left_join(., new_admission_dates, by = "id") %>%
#   filter(firstDate > firstDate_new | lastDate > lastDate_new)
admission_nodscov2 = admission_nodscov2 %>%
  left_join(., new_admission_dates, by = "id") %>%
  mutate(
    firstDate = case_when(status == "PE" ~ firstDate_new, .default = firstDate),
    lastDate = case_when(status == "PE" ~ lastDate_new, .default = lastDate)
  ) %>%
  select(-c(firstDate_new, lastDate_new))

```

## Change IDs of individuals to integrate PA or PE at the start of each ID 
```{r change ids}
# This is a necessary step for the synthetic contact algorithm
# Interaction data
interaction_nodscov2 = interaction_nodscov2 %>%
  mutate(
    from = case_when(
      from %in% admission_nodscov2$id[admission_nodscov2$status == "PA"] ~ paste0("PA-", from),
      from %in% admission_nodscov2$id[admission_nodscov2$status == "PE"] ~ paste0("PE-", from)
    ),
    to = case_when(
      to %in% admission_nodscov2$id[admission_nodscov2$status == "PA"] ~ paste0("PA-", to),
      to %in% admission_nodscov2$id[admission_nodscov2$status == "PE"] ~ paste0("PE-", to)
    ),
  )

# Admission data
admission_nodscov2 = admission_nodscov2 %>%
  mutate(id = paste0(status, "-", id))

# Patient rooms
patient_rooms = patient_rooms %>%
  mutate(id = paste0("PA-", id))

# HCW schedule
new_agenda = new_agenda %>%
  mutate(id = paste0(status, "-", id))

```


## Save data for synthetic algorithm
```{r save synthetic}
# Interaction data
write.csv2(interaction_nodscov2, file.path(synthetic_path, "interactions.csv"), quote = F, row.names = F)

# Admission data
write.csv2(admission_nodscov2, file.path(synthetic_path, "admission.csv"), quote = F, row.names = F)

# HCW schedule
write.csv2(new_agenda, file.path(synthetic_path, "agenda.csv"),  quote = F, row.names = F)

# Patient rooms
write.csv2(patient_rooms, file.path(synthetic_path, "patient_rooms.csv"), quote = F, row.names = F)
```

## Plot raw data for supplementary materials
### Before filtration
```{r plots before filtration}
# Number of individuals by category
admission_full = admission %>%
  filter(hospital == "APHP - RAYMOND POINCARÉ", ward == "Reanimation", !cat %in% "investigation") %>%
  mutate(cat = case_when(is.na(cat) ~ "Patient",
                         cat %in% cat_paramedical ~ "Paramedical",
                         cat %in% cat_medical ~ "Medical",
                         .default = stringr::str_to_title(cat)
                         )) 
p1 = admission_full %>%
  group_by(cat) %>% 
  summarise(n =n()) %>% 
  ggplot(., aes(x = cat, y = n, fill = cat)) + 
  geom_bar(stat = "identity", width = 0.5) + 
  scale_fill_manual(values = pal) +
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "", y = "Number of individuals")
  
# Number of interactions
p2 = list_ward %>%
  filter(newID == "Medical ICU #1") %>%
  left_join(., admission_full %>% select(id, cat) %>% rename(cat_from = cat), by = c("from" = "id")) %>%
  left_join(., admission_full %>% select(id, cat) %>% rename(cat_to = cat), by = c("to" = "id")) %>%
  filter(!is.na(cat_to), !is.na(cat_from)) %>%
  mutate(cat_from = case_when(cat_from %in% c("Paramedical", "Medical") ~ "HCW",
                              !cat_from %in% c("Patient", "Paramedical", "Medical") ~ "Other",
                              .default = cat_from), 
         cat_to = case_when(cat_to %in% c("Paramedical", "Medical") ~ "HCW",
                              !cat_to %in% c("Patient", "Paramedical", "Medical") ~ "Other",
                              .default = cat_to),
         date_posix_first = as_datetime(date_posix_first)
         ) %>%
  mutate(cat_pair = case_when(
    cat_from == "Patient" & cat_to == "Patient" ~ "Patient-Patient",
    (cat_from == "Patient" & cat_to == "HCW") | (cat_from == "HCW" & cat_to == "Patient") ~ "Patient-HCW",
    (cat_from == "Patient" & cat_to == "Other") | (cat_from == "Other" & cat_to == "Patient") ~ "Patient-Other",
    (cat_from == "HCW" & cat_to == "Other") | (cat_from == "Other" & cat_to == "HCW") ~ "HCW-Other",
    cat_from == "HCW" & cat_to == "HCW" ~ "HCW-HCW",
    cat_from == "Other" & cat_to == "Other" ~ "Other-Other"
    )) %>%
  filter(cat_pair != "Patient-Patient") %>%
  mutate(id_pair = 1:n()) %>%
  group_by(id_pair, from, to, cat_pair, date_posix_first) %>%
  nest() %>%
  mutate(out = map2(data, date_posix_first, function(.x, .y) data.frame(interacting = seq.POSIXt(.y, .y+.x$length, 10)))) %>%
  ungroup() %>%
  select(-data) %>%
  unnest(cols = out) %>%
  group_by(cat_pair, interacting) %>%
  summarise(n =n(), .groups = "drop") %>%
  ggplot(., aes(x= interacting, y = n, col = cat_pair)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("Patient-HCW" = "orange", "HCW-HCW" = "orchid", 
                                "Patient-Other" = "black", "HCW-Other" = "grey80", "Other-Other" = "cornflowerblue")) +
  labs(x = "Time", y="Number of interactions", col = "Type of interaction")

# Combined plot
ggarrange(p1, p2, ncol = 2, align = "hv", widths = c(1,2), labels = c("A", "B"))

# Interaction network 

```

### After filtration
```{r plots after filtration}
# Number of individuals by category
p1 = admission_nodscov2 %>% 
  group_by(cat) %>% 
  summarise(n =n()) %>% 
  ggplot(., aes(x = cat, y = n, fill = cat)) + 
  geom_bar(stat = "identity", width = 0.5) + 
  scale_fill_manual(values = pal) +
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "", y = "Number of individuals")
  
# Number of interactions
p2 = interaction_nodscov2 %>%
  left_join(., admission_nodscov2 %>% select(id, cat) %>% rename(cat_from = cat), by = c("from" = "id")) %>%
  left_join(., admission_nodscov2 %>% select(id, cat) %>% rename(cat_to = cat), by = c("to" = "id")) %>%
  mutate(cat_pair = case_when(
    cat_from == "Patient" & cat_to == "Patient" ~ "Patient-Patient",
    (cat_from == "Patient" & cat_to != "Patient") | (cat_from != "Patient" & cat_to == "Patient") ~ "Patient-HCW",
    cat_from != "Patient" & cat_to != "Patient" ~ "HCW-HCW"
    ),
    id_pair = 1:n()) %>%
  filter(cat_pair != "Patient-Patient") %>%
  group_by(id_pair, from, to, cat_pair, date_posix_first) %>%
  nest() %>%
  mutate(out = map2(data, date_posix_first, function(.x, .y) data.frame(interacting = seq.POSIXt(.y, .y+.x$length, 10)))) %>%
  ungroup() %>%
  select(-data) %>%
  unnest(cols = out) %>%
  group_by(cat_pair, interacting) %>%
  summarise(n =n(), .groups = "drop") %>%
  ggplot(., aes(x= interacting, y = n, col = cat_pair)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("Patient-HCW" = "orange", "HCW-HCW" = "orchid")) +
  labs(x = "Time", y="Number of interactions", col = "Type of interaction")

# Combined plot
ggarrange(p1, p2, ncol = 2, align = "hv", widths = c(1,2), labels = c("A", "B"))

# Interaction network

```


<!-- observed_path <- file.path(data_path,"data-observed") -->
<!-- synthetic_path <- file.path(data_path, "data-synthetic-graphs") -->
<!-- simplified_path <- file.path(data_path, "data-simplified") -->
<!-- expanded_path <- file.path(data_path,"data-expanded") -->


<!-- ## PLOTS -->
<!-- ```{r} -->
<!-- ## Reanimation wards -->
<!-- admission %>% -->
<!--   filter(ward == "Reanimation" ) %>% -->
<!--   filter(hospital != "APHP - NECKER ENFANTS MALADES") %>% -->
<!--   mutate(cat = ifelse(is.na(cat), "Patients", cat)) %>% -->
<!--   group_by(hospital, cat) %>% -->
<!--   summarise( n = n(), .groups = "drop") %>% -->
<!--     ggplot(., aes(x = cat, y = n)) + -->
<!--     geom_bar(stat = "identity") + -->
<!--     facet_grid(cols = vars(hospital)) + -->
<!--     theme_bw() + -->
<!--     theme(axis.text.x = element_text(angle = 35, hjust = 1)) + -->
<!--   labs(x = "Categories", y = "Number of individuals") -->

<!-- ## ReaChirurgie wards (For HC LYON EDOUARD HERRIOT 's REACHIRURGIE WARD) -->
<!-- admission %>% -->
<!--   filter(ward == "ReaChirurgie") %>% -->
<!--   mutate(cat = ifelse(is.na(cat), "Patients", cat)) %>% -->
<!--   group_by(hospital, cat) %>% -->
<!--   summarise( n = n(), .groups = "drop") %>% -->
<!--     ggplot(., aes(x = cat, y = n)) + -->
<!--     geom_bar(stat = "identity") + -->
<!--     facet_grid(cols = vars(hospital)) + -->
<!--     theme_bw() + -->
<!--     theme(axis.text.x = element_text(angle = 35, hjust = 1)) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- ## FIGURE FOR RP REPORT -->
<!-- ## CATEGORY GROUPING INTO TYPE -->
<!-- cat_other <- c('logistic', 'visitor', 'investigation', 'administration') -->
<!-- cat_paramedical <- c("nurse", "student nurse", "aux nurse") -->
<!-- cat_medical <- c("physician", "ext physician", "reeducation staff", "other") -->

<!-- pal = c('Medical' = "#5CD6D6", 'Paramedical' = "#A9B9E8", 'Patient' = "#FFA766", 'Other' = "#666699") -->

<!-- adm_plot <- admission %>% -->
<!--   filter(ward == "Reanimation" ) %>% -->
<!--   filter(hospital == "APHP - RAYMOND POINCARÉ") %>% -->
<!--   mutate(cat = ifelse(is.na(cat), "patient", cat)) %>% -->
<!--   mutate(Type = case_when( -->
<!--     cat %in% cat_paramedical ~ 'Paramedical', -->
<!--     cat %in% cat_medical ~ 'Medical', -->
<!--     cat == 'patient' ~ 'Patient', -->
<!--     .default = 'Other' -->
<!--   )) %>%  -->
<!--   group_by(hospital, cat, Type) %>% -->
<!--   summarise(n = n(), .groups = "drop") -->
<!-- adm_plot$Type <- factor(adm_plot$Type, levels = c('Paramedical', 'Medical', 'Patient', 'Other')) -->
<!-- adm_plot <- adm_plot %>% -->
<!--   arrange(Type, desc(n)) -->
<!-- adm_plot$cat <- factor(adm_plot$cat, levels = adm_plot$cat) -->

<!-- p_n_RP <- ggplot(adm_plot, aes(x = cat, y = n, fill = Type)) + -->
<!--   geom_bar(stat = "identity") + -->
<!--   theme_bw() + -->
<!--   scale_fill_manual(values = pal) + -->
<!--   labs(title = "" ,x = "", y = "Number of individuals") + -->
<!--   #labs(title = "APHP - RAYMOND POINCARÉ" ,x = "Categories", y = "Number of individuals") + -->
<!--   theme( -->
<!--     axis.text.x = element_text(angle = 35, hjust = 1), -->
<!--     plot.title = element_text(size = 45, hjust = 0.5), # -->
<!--     axis.text = element_text(size = 40), -->
<!--     axis.title = element_text(size = 40), -->
<!--     legend.text = element_text(size = 40), -->
<!--     legend.title = element_text(size = 40)) + -->
<!--   geom_text(aes(label=n), vjust=-0.25, size=10) -->

<!-- print(p_n_RP) -->
<!-- ggsave(filename = file.path(wd, '..', '..', 'out', 'fig', 'RP-number-individual-before.png'), plot = p_n_RP, height = 14, width = 26) -->
<!-- ``` -->


<!-- ## DF of interest -->
<!-- ```{r} -->
<!-- ## We keep wards with the lowest number of visitors (hyp. no visitors) -->
<!-- keep_names <- c("Raymond_Poincare-Reanimation-20200506-20200507", -->
<!--           "Edouard_Herriot-Reanimation-20200609-20200610") -->

<!-- list_rea <- list_ward[keep_names] -->
<!-- ``` -->


<!-- ## MODIFY INDIVIDUAL IDS (include PA/PE in id) -->
<!-- ```{r} -->
<!-- ## (TEMPORARY) -->
<!-- admission_rea <- admission %>% -->
<!--   filter(ward == "Reanimation") %>%  -->
<!--   filter(hospital != "APHP - NECKER ENFANTS MALADES") -->

<!-- table(admission_rea$hospital, admission_rea$cat) -->
<!-- rm(admission_rea) -->
<!-- ## END (TEMPORARY) -->



<!-- ## FILTER ADMISSION -->
<!-- admission_keep <- admission %>% -->
<!--   ## Remove visitors/admin/logistics/investigators -->
<!--   filter(ward == "Reanimation") %>%  -->
<!--   filter(hospital != "APHP - NECKER ENFANTS MALADES") %>% -->
<!--   filter(!(cat %in% c("administration", -->
<!--                   "investigation", -->
<!--                   "logistic", -->
<!--                   "visitor"))) %>% -->
<!--   ## ADD PE/PA IN ADMISSION'S IDs (id) -->
<!--   mutate(id_bis = paste0(status,"-",id)) -->


<!-- list_rea <- list_ward[keep_names] -->
<!-- ## FILTER THE DATAFRAMES -->
<!-- list_rea <- lapply(list_rea, function(x) { -->
<!--   ## FILTER INTERACTIONS TO KEEP ONLY HCW AND PATIENTS -->
<!--   x <- x%>% filter(from %in% admission_keep$id & to %in% admission_keep$id) -->
<!--   ## ADD INFO OF THE STATUS FOR INDIVIDUALS -->
<!--   x <- left_join(x, admission_keep %>% select(id, status), by = c("from" = "id")) %>% -->
<!--     rename(from_status = status) %>% -->
<!--     left_join(admission_keep %>% select(id, status), by = c("to" = "id")) %>% -->
<!--     rename(to_status = status) -->
<!-- }) -->
<!-- ``` -->


<!-- ## DISTRIBUTIONS -->
<!-- ```{r} -->
<!-- poincare <- "Raymond_Poincare-Reanimation-20200506-20200507" -->
<!-- herriot <- "Edouard_Herriot-Reanimation-20200609-20200610" -->


<!-- data_rea <- bind_rows( -->
<!--   mutate(list_rea[[poincare]], hospital = "Raymond Poicaré"), -->
<!--   mutate(list_rea[[herriot]], hospital = "Edouard Herriot") ) %>% -->
<!--   mutate(type_int = paste0(from_status, "-", to_status)) %>% -->
<!--   mutate(type_int = ifelse(type_int == "PA-PE", "PE-PA", type_int)) -->


<!-- ## n / type of int -->
<!-- data_rea %>% -->
<!--   group_by(hospital, type_int) %>% -->
<!--   summarise(n = n(), .groups = "drop") %>% -->
<!--   ggplot(aes(x = type_int, y = n)) + -->
<!--   geom_bar(stat = "identity") + -->
<!--   facet_grid(cols = vars(hospital)) + -->
<!--   theme_bw() + -->
<!--   theme(axis.text.x = element_text(angle = 35, hjust = 1)) + -->
<!--   labs(title = "Number of interaction over time") -->

<!-- # n distribution / hour -->
<!-- data_rea %>% -->
<!--   group_by(hospital, hour(date_posix_first), type_int) %>% -->
<!--   summarise(n = n(), .groups = "drop") %>% -->
<!--   mutate(hour = `hour(date_posix_first)`) %>% -->
<!--   ggplot(aes(x = hour, y = n)) + -->
<!--   geom_bar(stat = "identity") + -->
<!--   facet_grid(cols = vars(type_int), rows = vars(hospital)) + -->
<!--   theme_bw() + -->
<!--   theme(axis.text.x = element_text(angle = 35, hjust = 1)) + -->
<!--   labs(title = "Number of interaction over time") + -->
<!--   labs(x = "Hour of the day", y = "Number of interactions") -->

<!-- ``` -->


<!-- ## Cumulative time spent with patients by category of HCW -->
<!-- ```{r} -->
<!-- length_cat <- list_rea[[poincare]] %>% -->
<!--   filter((from_status == "PA" & to_status == "PE") | (from_status == "PE" & to_status == "PA")) %>% -->
<!--   mutate(id_pe = ifelse(from_status == "PE", from, to)) %>% -->
<!--   left_join(admission %>% select(id, cat), by = c("id_pe" = "id")) -->


<!-- sum_length_cat <- length_cat %>% -->
<!--   group_by(id_pe, cat) %>% -->
<!--   summarise( -->
<!--     sum_cat = sum(length), -->
<!--     n_cat = n(), -->
<!--     adj_sum_cat = sum_cat / n_cat, -->
<!--     .groups = 'drop' -->
<!--   ) -->

<!-- # Boxplot & jittered points -->
<!-- sum_length_cat %>% -->
<!--   ggplot( aes(x=cat, y=sum_cat/3600, fill=cat)) + -->
<!--     geom_boxplot() + -->
<!--     scale_fill_viridis(discrete = TRUE, alpha=0.6) + -->
<!--     geom_jitter(color="black", size=0.4, alpha=0.9) + -->
<!--     theme_bw() + -->
<!--     theme( -->
<!--       legend.position="none", -->
<!--       plot.title = element_text(size=11), -->
<!--       axis.text.x = element_text(angle = 35, hjust = 1) -->
<!--     ) + -->
<!--     ggtitle("Cumulative time spent interacting with patient by category of HCW") + -->
<!--     xlab("") + -->
<!--     ylab("Cumulative time interacting (h)") -->

<!-- # Violin plot -->
<!-- sum_length_cat %>% -->
<!--   ggplot( aes(x=cat, y=sum_cat/3600, fill=cat)) + -->
<!--     geom_violin() + -->
<!--     scale_fill_viridis(discrete = TRUE, alpha=0.6) + -->
<!--     geom_jitter(color="black", size=0.4, alpha=0.9) + -->
<!--     theme_bw() + -->
<!--     theme( -->
<!--       legend.position="none", -->
<!--       plot.title = element_text(size=11), -->
<!--       axis.text.x = element_text(angle = 35, hjust = 1) -->
<!--     ) + -->
<!--     ggtitle("Cumulative time spent interacting with patient by category of HCW") + -->
<!--     xlab("") + -->
<!--     ylab("Cumulative time interacting (h)") -->

<!-- ``` -->



<!-- ## PA-PA INTERACTIONS -->
<!-- ```{r} -->
<!-- k_RP <- list_rea[[poincare]] #%>% filter(length > 300) -->
<!-- k_EH <- list_rea[[herriot]] #%>% filter(length > 300) -->

<!-- table(k_RP$from_status, k_RP$to_status) -->
<!-- k_RP %>% filter(from_status == "PA" & to_status == "PA") -->
<!-- k_RP %>% filter(from_status == "PA" & to_status == "PA") %>% group_by(from,to) %>% summarise(len = sum(length)) -->

<!-- table(k_EH$from_status, k_EH$to_status) -->
<!-- k_EH %>% filter(from_status == "PA" & to_status == "PA") -->
<!-- k_EH %>% filter(from_status == "PA" & to_status == "PA") %>% group_by(from) %>% summarise(len = sum(length)) -->
<!-- ``` -->

<!-- ## Raymond Poincaré double rooms hypothesis -->
<!-- ```{r} -->
<!-- ### HYP : "001-0038-B-S" and "001-0039-B-F" are in the same room -->
<!-- ## ORDER FROM/TO -->
<!-- temp_a <- list_rea[[poincare]] %>% -->
<!--   filter(from %in% c("001-0038-B-S", "001-0039-B-F")  -->
<!--          | to %in% c("001-0038-B-S", "001-0039-B-F")) %>% -->
<!--   filter(!(from_status == "PA" & to_status == "PA")) %>% -->
<!--   mutate(n_from = ifelse((from == "001-0038-B-S" | from == "001-0039-B-F"), from, to  ) -->
<!--          , n_to = ifelse((to == "001-0038-B-S" | to == "001-0039-B-F"), from, to)) -->


<!-- pe_a <- unique(c(temp_a$to[temp_a$to_status == "PE"])) -->
<!-- overlap_a <- data.frame() -->

<!-- for (individual in pe_a) { -->
<!--   # Filter to keep only HCW's interaction -->
<!--   interactions <- temp_a %>% -->
<!--     filter(n_to == individual) -->

<!--   # If the HCW interacts with both patients -->
<!--   if (nrow(interactions) >= 2) { -->
<!--     # double for loop to check if i and [j=i+1;n] are overlapping] for i 1:nrow(interaction) -->
<!--     for (i in 1:(nrow(interactions)-1)) { -->
<!--       for (j in (i+1):nrow(interactions)) { -->
<!--         # Check if overlapping -->
<!--         if (interactions$date_posix_first[i] <= (interactions$date_posix_first[j] + interactions$length[j]) && -->
<!--             (interactions$date_posix_first[i] + interactions$length[i]) >= interactions$date_posix_first[j]) { -->
<!--           if (interactions$n_from[i] != interactions$n_from[j]){ -->
<!--           overlap_a <- bind_rows(overlap_a, interactions[c(i, j), ])  -->
<!--           } -->
<!--         } -->
<!--       } -->
<!--     } -->
<!--   } -->
<!-- } -->
<!-- rm(pe_a) -->
<!-- rm(interactions) -->
<!-- rm(temp_a) -->

<!-- summary(overlap_a) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- ### HYP : "001-0127-B-A" and "001-0128-Z-K" are in the same room -->

<!-- temp_b <- list_rea[[poincare]] %>% -->
<!--   filter(from %in% c("001-0127-B-A", "001-0128-Z-K" )  -->
<!--          | to %in% c("001-0127-B-A", "001-0128-Z-K" )) %>% -->
<!--   filter(!(from_status == "PA" & to_status == "PA")) %>% -->
<!--   mutate(n_from = ifelse((from == "001-0127-B-A" | from == "001-0128-Z-K"), from, to  ) -->
<!--          , n_to = ifelse((to == "001-0127-B-A" | to == "001-0128-Z-K"), from, to)) -->


<!-- pe_b <- unique(c(temp_b$to[temp_b$to_status == "PE"])) -->
<!-- overlap_b <- data.frame() -->

<!-- for (individual in pe_b) { -->
<!--   # Filter to keep only HCW's interaction -->
<!--   interactions <- temp_b %>% -->
<!--     filter(n_to == individual) -->

<!--   # If the HCW interacts with both patients -->
<!--   if (nrow(interactions) >= 2) { -->
<!--     # double for loop to check if i and [j=i+1;n] are overlapping] for i 1:nrow(interaction) -->
<!--     for (i in 1:(nrow(interactions)-1)) { -->
<!--       for (j in (i+1):nrow(interactions)) { -->
<!--         # Check if overlapping -->
<!--         if (interactions$date_posix_first[i] <= (interactions$date_posix_first[j] + interactions$length[j]) && -->
<!--             (interactions$date_posix_first[i] + interactions$length[i]) >= interactions$date_posix_first[j]) { -->
<!--           if (interactions$n_from[i] != interactions$n_from[j]){ -->
<!--           overlap_b <- bind_rows(overlap_b, interactions[c(i, j), ])  -->
<!--           } -->
<!--         } -->
<!--       } -->
<!--     } -->
<!--   } -->
<!-- } -->
<!-- rm(pe_b) -->
<!-- rm(interactions) -->
<!-- rm(temp_b) -->

<!-- summary(overlap_b) -->
<!-- ``` -->
<!-- ################################# GARBAGE ############################## -->

