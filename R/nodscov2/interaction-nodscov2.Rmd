---
title: "Interaction-nodscov2"
author: "Olivier GAUFRÈS"
date: "2024-05-03"
output: html_document
---

## Libraries
```{r setup, include=TRUE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lubridate)
library(tidyr)
library(viridis)
library(purrr)
rm(list = ls())

# Source functions, dictionaries and helpful variables
source("interaction-nodscov2-supp.R")
```

## Working directory & paths
```{r wd and paths}
data_path = file.path("..", "..", "data")
# observed_path <- file.path(data_path,"data-observed")
# synthetic_path <- file.path(data_path, "data-synthetic-graphs")
# simplified_path <- file.path(data_path, "data-simplified")
# expanded_path <- file.path(data_path,"data-expanded")
nodscov2_path = file.path("..", "..", "data", "data-nodscov2") 
synthetic_path = file.path("..", "..", "data", "data-synthetic-graphs")
```


## NodsCov2 data (not shared)
```{r, echo=FALSE}
# Admission dates
load(file.path(nodscov2_path, "admission_ctc_nodscov2.RData"))
Encoding(admission$hospital) <- 'latin1'

# Interactions 
list_ward = read.csv(file.path(nodscov2_path, "list_ward_complete.csv"))

# Sensor distribution 
sensor = read.csv(file.path(nodscov2_path, "met_timespent_mins_complete.csv"))
```

## Create input dataframes for the synthetic network algorithm 
```{r synthetic data}
# Create dataframe with admission dates for the synthetic network algorithm
admission_nodscov2 = admission %>%
  filter(
    hospital == "APHP - RAYMOND POINCARÉ", 
    ward == "Reanimation",
    !cat %in% c("administration", "investigation", "logistic", "visitor")
    ) %>%
  mutate(cat = recode(cat, !!!dict_cat)) %>%
  select(-hospital)

# Interaction data from Raymond Poincaré
interaction_nodscov2 = list_ward %>%
  filter(
    # Raymond Poincaré ICU
    newID == "Medical ICU #1",
    # Only categories of interest
    from %in% admission_nodscov2$id, to %in% admission_nodscov2$id
    ) %>% 
  mutate(date_posix_first = strptime(date_posix_first, "%Y-%m-%dT%H:%M:%SZ"))

interaction_first_last = interaction_nodscov2 %>%
  mutate(date_day = as.Date(cut.POSIXt(date_posix_first, "day"))) %>%
  pivot_longer(cols = c(from, to), values_to = "id") %>%
  group_by(id) %>%
  summarise(firstDate_interaction = min(date_day), lastDate_interaction = max(date_day))

# Sensor distribution data 
# Keep individuals from the ICU of Raymond Poincaré
# Keep individuals that have a sensor between noon on the 1st day and noon on the 2nd day 
sensor_nodscovd2 = sensor %>%
  mutate(
    DATEREMISEJ1 = strptime(DATEREMISEJ1, "%Y-%m-%dT%H:%M:%SZ"),
    DATERECJ1 = strptime(DATERECJ1, "%Y-%m-%dT%H:%M:%SZ"),
    DATEREMISEJ2 = strptime(DATEREMISEJ2, "%Y-%m-%dT%H:%M:%SZ"),
    DATERECJ2 = strptime(DATERECJ2, "%Y-%m-%dT%H:%M:%SZ"),
    J1 = strptime(J1, "%Y-%m-%dT%H:%M:%SZ"),
    N1 = strptime(N1, "%Y-%m-%dT%H:%M:%SZ"),
    J2 = strptime(J2, "%Y-%m-%dT%H:%M:%SZ"),
    N2 = strptime(N2, "%Y-%m-%dT%H:%M:%SZ"),
    firstDate_sensor = as.Date(cut(DATEREMISEJ1, "day")), 
    lastDate_sensor = as.Date(case_when(is.na(DATERECJ2) ~ cut(DATERECJ1, "day"), .default = cut(DATERECJ2, "day")))
  ) %>%
  filter(
    id %in% admission_nodscov2$id,
    (DATERECJ1 >= noon_day1 & DATERECJ1 <= noon_day2) | 
      (DATEREMISEJ1 >= noon_day1 & DATEREMISEJ1 <= noon_day2) |
      (DATERECJ2 >= noon_day1 & DATERECJ2 <= noon_day2) |
      (DATEREMISEJ2 >= noon_day1 & DATEREMISEJ2 <= noon_day2) |
      (DATEREMISEJ1 <= noon_day1 & DATERECJ1 >= noon_day2) |
      (DATEREMISEJ2 <= noon_day1 & DATERECJ2 >= noon_day2)
    )
selected_individuals = sensor$id  

# Compare first date and last date in the admission data, sensor distribution data 
# and interaction data
admission_nodscov2 %>%
  left_join(., sensor_nodscovd2 %>% select(id, firstDate_sensor, lastDate_sensor), by = "id") %>%
  left_join(., interaction_first_last, by = "id") %>%
  filter(firstDate_sensor != firstDate_interaction)

admission_nodscov2 %>%
  left_join(., sensor_nodscovd2 %>% select(id, firstDate_sensor, lastDate_sensor), by = "id") %>%
  left_join(., interaction_first_last, by = "id") %>%
  filter(lastDate_sensor != lastDate_interaction)

# Use sensor distribution data for the first and last date in admission
admission_nodscov2 = admission_nodscov2 %>%
  select(-c(firstDate, lastDate)) %>%
  inner_join(., sensor_nodscovd2 %>% select(id, firstDate_sensor, lastDate_sensor), by = "id") %>%
  rename(firstDate = firstDate_sensor, lastDate = lastDate_sensor) %>%
  select(id, status, firstDate, lastDate, ward, sex, hospitalization, cat)

# Trim data to keep only 24 hours of interactions
interaction_nodscov2 = interaction_nodscov2 %>%
  mutate(final_time = date_posix_first + length) %>%
  filter(date_posix_first >= noon_day1 & date_posix_first <= noon_day2 |
           final_time >= noon_day1 & final_time <= noon_day2) %>%
  mutate(
    length = case_when(
      date_posix_first <= noon_day1 & final_time >= noon_day1 ~ as.numeric(final_time - noon_day1),
      date_posix_first <= noon_day2 & final_time >= noon_day2 ~ as.numeric(noon_day2 - date_posix_first),
      .default = length 
    ),
    date_posix_first = case_when(
      date_posix_first <= noon_day1 & final_time >= noon_day1 ~ noon_day1,
      .default = date_posix_first
    )
  )

# Agenda of healthcare workers
agenda_nodscov2 = sensor_nodscovd2 %>%
  select(id, DATEREMISEJ1, DATERECJ1, DATEREMISEJ2, DATERECJ2) %>%
  pivot_longer(-id, names_to = c(".value", "Day"), names_sep = "J") %>% 
  rename(firstDate = DATEREMISE, lastDate = DATEREC) %>%
  mutate(ward = "Reanimation") %>%
  left_join(., admission_nodscov2 %>% select(id, status, cat), by = "id") %>%
  filter(!is.na(firstDate), status != "PA") %>%
  select(id, status, cat, ward, firstDate, lastDate) %>%
  mutate(
    firstDate = case_when(firstDate <= noon_day1 ~ noon_day1, .default = firstDate),
    lastDate = case_when(lastDate >= noon_day2 ~ noon_day2, .default = lastDate)
  )

```

## Contact recurrence probability 
```{r contact recurrence}
# Hourly individual probability of recurring contacts and mean individual
# probability
pind = rep(NA, nrow(admission_nodscov2))
for (i in seq_along(admission_nodscov2$id)) {
  ii = admission_nodscov2$id[i]
  
  # Get n hours spent in the ward with a sensor 
  all_h = sensor_nodscovd2 %>%
    filter(id == ii) %>%
    select(id, DATEREMISEJ1, DATERECJ1, DATEREMISEJ2, DATERECJ2) %>%
    pivot_longer(-id, names_to = c(".value", "Day"), names_sep = "J") %>%
    filter(!is.na(DATEREMISE)) %>%
    mutate(DATEREMISE = cut(DATEREMISE, "hour"), DATEREC = cut(DATEREC, "hour")) %>%
    arrange(DATEREMISE) %>%
    group_by(Day) %>%
    nest() %>%
    mutate(out = map(data, unroll_dates)) %>%
    unnest(out) %>%
    .$date_list
    
  if (length(all_h) > 1) {
    interaction_h = vector("list", length(all_h))
    proba_h = rep(NA, length(all_h)-1)
    
    # Get lists of contacts per hour
    for (h in seq_along(all_h)) {
      hh = all_h[h]
      contacts = interaction_nodscov2 %>%
        filter(from == ii | to == ii, date_posix_first >= hh, date_posix_first < hh+3600) %>%
        select(from, to) %>%
        unlist()
      contacts = unique(contacts[contacts != ii])
      names(contacts) = NULL
      interaction_h[[h]] = contacts 
    }
    
    # Get hourly probability of recurring contacts
    if (length(all_h)>1) {
      for (h in 2:length(all_h)) {
        if (length(interaction_h[[h]]) > 0) {
          proba_h[h-1] = sum(interaction_h[[h]] %in% unlist(interaction_h[1:(h-1)])) / length(interaction_h[[h]])
        } else {
          proba_h[h-1] = 0
        }
      }
    } 
  } else {
    proba_h = 0
  }

  # Mean individual hourly probability of recurring contacts
  pind[i] = sum(proba_h) / length(all_h)
}

# Plot mean individual probability of recurring contacts
admission_nodscov2 %>%
  mutate(pind = pind, cat = ifelse(is.na(cat), "patient", cat)) %>%
  ggplot(., aes(x = cat, y = pind)) +
  geom_boxplot() +
  geom_jitter() +
  theme_bw() +
  labs(x = "", y = "Probability of hourly recurring contact")

# Mean probability of recurring contacts by individual category
admission_nodscov2 %>%
  mutate(pind = pind, cat = ifelse(is.na(cat), "patient", cat)) %>%
  group_by(cat) %>%
  summarise(m = mean(pind), .groups = "drop")

# Comparison by category of individual
admission_nodscov2 %>%
  mutate(pind = pind, cat = ifelse(is.na(cat), "patient", cat)) %>%
  rstatix::wilcox_test(pind ~ cat, ref.group = "paramedical staff")

# Mean probability when aggregating paramedical and medical staff
admission_nodscov2 %>%
  mutate(pind = pind, cat = ifelse(is.na(cat), "patient", "hcw")) %>%
  group_by(cat) %>%
  summarise(m = mean(pind), .groups = "drop")
  
```

## Patient augmentation
```{r patient augmentation}
set.seed(20240924)
last_day = as.Date("2020-05-07") + 90
for (id in admission_nodscov2$id[admission_nodscov2$status == "PA"]) {
  
  # Stay length of original individual
  if (admission_nodscov2$lastDate[admission_nodscov2$id == id] == as.Date("2020-05-07")) {
    stay_length = sample(6:13, 1)
    new_lastDate = as.Date("2020-05-06") + stay_length
    admission_nodscov2$lastDate[admission_nodscov2$id == id] = new_lastDate
  } else {
    new_lastDate = as.Date("2020-05-06")
  }
  
  # Augment patients by keeping the incrementing the original id
  i = 1
  while(new_lastDate < last_day) {
    stay_length = sample(6:13, 1)
    to_rbind = data.frame(
      id = paste0(id, "-", i),
      status = "PA",
      firstDate = new_lastDate,
      lastDate = min(new_lastDate+stay_length, last_day),
      ward = "Reanimation",
      sex = NA,
      hospitalization = "patient",
      cat = NA
    )  
    admission_nodscov2 = rbind(admission_nodscov2, to_rbind)
    new_lastDate = new_lastDate+stay_length
  }
}
```


## Repeat schedule of HCWs over the 90-day period
```{r}
# Repeat schedule over 90 days
new_agenda = agenda_nodscov2
for (d in 1:90) {
  new_agenda = rbind(new_agenda, agenda_nodscov2 %>% mutate(firstDate = firstDate+3600*24*d,
                                                            lastDate = lastDate+3600*24*d))
}
new_agenda = new_agenda %>%
  filter(lastDate <= noon_last_day)

# Get new admission dates for HCWs
new_admission_dates = new_agenda %>%
  group_by(id) %>%
  summarise(firstDate_new = as.Date(cut.POSIXt(min(firstDate), "day")),
            lastDate_new = as.Date(cut.POSIXt(max(lastDate), "day")),
            .groups = "drop")

# Verify coherence and change admission dates for HCWs
# admission_nodscov2 %>%
#   left_join(., new_admission_dates, by = "id") %>%
#   filter(firstDate > firstDate_new | lastDate > lastDate_new)
admission_nodscov2 = admission_nodscov2 %>%
  left_join(., new_admission_dates, by = "id") %>%
  mutate(
    firstDate = case_when(status == "PE" ~ firstDate_new, .default = firstDate),
    lastDate = case_when(status == "PE" ~ lastDate_new, .default = lastDate)
  ) %>%
  select(-c(firstDate_new, lastDate_new))

```


## Save data for synthetic algorithm
```{r save synthetic}
# Interaction data
write.csv2(interaction_nodscov2, file.path(synthetic_path, "interactions.csv"), quote = F, row.names = F)

# Admission data
write.csv2(admission_nodscov2, file.path(synthetic_path, "admission.csv"), quote = F, row.names = F)

# HCW schedule
write.csv2(new_agenda, file.path(synthetic_path, "agenda.csv"),  quote = F, row.names = F)
```


## Plot distribution of selected individuals
```{r}


```

## Plot distribution graphs
```{r}


```



## Individual proportions
```{r}
head(admission)

## Patients / HCW in all wards/hospitals
table(admission$status)

## Patients / HCW by cat (NA == patients)
table(admission$status, admission$cat, useNA = "always") 

## Proportion of individuals/ward etc..
table(admission$hospital, admission$ward)
```


## "FILTRATION"
```{r}
head(admission %>% filter(ward == "Reanimation"))

## Ind in each reanimation ward
head(admission %>% filter(ward == "Reanimation") %>% group_by(hospital) %>% summarise( n = n(), .groups = "drop"))

## Cat in each reanimation ward
head(admission %>% filter(ward == "Reanimation") %>% group_by(hospital, cat) %>% summarise( n = n(), .groups = "drop"))
```


## PLOTS
```{r}
## Reanimation wards
admission %>%
  filter(ward == "Reanimation" ) %>%
  filter(hospital != "APHP - NECKER ENFANTS MALADES") %>%
  mutate(cat = ifelse(is.na(cat), "Patients", cat)) %>%
  group_by(hospital, cat) %>%
  summarise( n = n(), .groups = "drop") %>%
    ggplot(., aes(x = cat, y = n)) +
    geom_bar(stat = "identity") +
    facet_grid(cols = vars(hospital)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(x = "Categories", y = "Number of individuals")

## ReaChirurgie wards (For HC LYON EDOUARD HERRIOT 's REACHIRURGIE WARD)
admission %>%
  filter(ward == "ReaChirurgie") %>%
  mutate(cat = ifelse(is.na(cat), "Patients", cat)) %>%
  group_by(hospital, cat) %>%
  summarise( n = n(), .groups = "drop") %>%
    ggplot(., aes(x = cat, y = n)) +
    geom_bar(stat = "identity") +
    facet_grid(cols = vars(hospital)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 35, hjust = 1))
```


```{r}
## FIGURE FOR RP REPORT
## CATEGORY GROUPING INTO TYPE
cat_other <- c('logistic', 'visitor', 'investigation', 'administration')
cat_paramedical <- c("nurse", "student nurse", "aux nurse")
cat_medical <- c("physician", "ext physician", "reeducation staff", "other")

pal = c('Medical' = "#5CD6D6", 'Paramedical' = "#A9B9E8", 'Patient' = "#FFA766", 'Other' = "#666699")

adm_plot <- admission %>%
  filter(ward == "Reanimation" ) %>%
  filter(hospital == "APHP - RAYMOND POINCARÉ") %>%
  mutate(cat = ifelse(is.na(cat), "patient", cat)) %>%
  mutate(Type = case_when(
    cat %in% cat_paramedical ~ 'Paramedical',
    cat %in% cat_medical ~ 'Medical',
    cat == 'patient' ~ 'Patient',
    .default = 'Other'
  )) %>% 
  group_by(hospital, cat, Type) %>%
  summarise(n = n(), .groups = "drop")
adm_plot$Type <- factor(adm_plot$Type, levels = c('Paramedical', 'Medical', 'Patient', 'Other'))
adm_plot <- adm_plot %>%
  arrange(Type, desc(n))
adm_plot$cat <- factor(adm_plot$cat, levels = adm_plot$cat)

p_n_RP <- ggplot(adm_plot, aes(x = cat, y = n, fill = Type)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  scale_fill_manual(values = pal) +
  labs(title = "" ,x = "", y = "Number of individuals") +
  #labs(title = "APHP - RAYMOND POINCARÉ" ,x = "Categories", y = "Number of individuals") +
  theme(
    axis.text.x = element_text(angle = 35, hjust = 1),
    plot.title = element_text(size = 45, hjust = 0.5), #
    axis.text = element_text(size = 40),
    axis.title = element_text(size = 40),
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40)) +
  geom_text(aes(label=n), vjust=-0.25, size=10)

print(p_n_RP)
ggsave(filename = file.path(wd, '..', '..', 'out', 'fig', 'RP-number-individual-before.png'), plot = p_n_RP, height = 14, width = 26)
```


## DF of interest
```{r}
## We keep wards with the lowest number of visitors (hyp. no visitors)
keep_names <- c("Raymond_Poincare-Reanimation-20200506-20200507",
          "Edouard_Herriot-Reanimation-20200609-20200610")

list_rea <- list_ward[keep_names]
```


## MODIFY INDIVIDUAL IDS (include PA/PE in id)
```{r}
## (TEMPORARY)
admission_rea <- admission %>%
  filter(ward == "Reanimation") %>% 
  filter(hospital != "APHP - NECKER ENFANTS MALADES")

table(admission_rea$hospital, admission_rea$cat)
rm(admission_rea)
## END (TEMPORARY)



## FILTER ADMISSION
admission_keep <- admission %>%
  ## Remove visitors/admin/logistics/investigators
  filter(ward == "Reanimation") %>% 
  filter(hospital != "APHP - NECKER ENFANTS MALADES") %>%
  filter(!(cat %in% c("administration",
                  "investigation",
                  "logistic",
                  "visitor"))) %>%
  ## ADD PE/PA IN ADMISSION'S IDs (id)
  mutate(id_bis = paste0(status,"-",id))


list_rea <- list_ward[keep_names]
## FILTER THE DATAFRAMES
list_rea <- lapply(list_rea, function(x) {
  ## FILTER INTERACTIONS TO KEEP ONLY HCW AND PATIENTS
  x <- x%>% filter(from %in% admission_keep$id & to %in% admission_keep$id)
  ## ADD INFO OF THE STATUS FOR INDIVIDUALS
  x <- left_join(x, admission_keep %>% select(id, status), by = c("from" = "id")) %>%
    rename(from_status = status) %>%
    left_join(admission_keep %>% select(id, status), by = c("to" = "id")) %>%
    rename(to_status = status)
})
```


## DISTRIBUTIONS
```{r}
poincare <- "Raymond_Poincare-Reanimation-20200506-20200507"
herriot <- "Edouard_Herriot-Reanimation-20200609-20200610"


data_rea <- bind_rows(
  mutate(list_rea[[poincare]], hospital = "Raymond Poicaré"),
  mutate(list_rea[[herriot]], hospital = "Edouard Herriot") ) %>%
  mutate(type_int = paste0(from_status, "-", to_status)) %>%
  mutate(type_int = ifelse(type_int == "PA-PE", "PE-PA", type_int))


## n / type of int
data_rea %>%
  group_by(hospital, type_int) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = type_int, y = n)) +
  geom_bar(stat = "identity") +
  facet_grid(cols = vars(hospital)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(title = "Number of interaction over time")

# n distribution / hour
data_rea %>%
  group_by(hospital, hour(date_posix_first), type_int) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(hour = `hour(date_posix_first)`) %>%
  ggplot(aes(x = hour, y = n)) +
  geom_bar(stat = "identity") +
  facet_grid(cols = vars(type_int), rows = vars(hospital)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(title = "Number of interaction over time") +
  labs(x = "Hour of the day", y = "Number of interactions")

```


## Cumulative time spent with patients by category of HCW
```{r}
length_cat <- list_rea[[poincare]] %>%
  filter((from_status == "PA" & to_status == "PE") | (from_status == "PE" & to_status == "PA")) %>%
  mutate(id_pe = ifelse(from_status == "PE", from, to)) %>%
  left_join(admission %>% select(id, cat), by = c("id_pe" = "id"))


sum_length_cat <- length_cat %>%
  group_by(id_pe, cat) %>%
  summarise(
    sum_cat = sum(length),
    n_cat = n(),
    adj_sum_cat = sum_cat / n_cat,
    .groups = 'drop'
  )

# Boxplot & jittered points
sum_length_cat %>%
  ggplot( aes(x=cat, y=sum_cat/3600, fill=cat)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.9) +
    theme_bw() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11),
      axis.text.x = element_text(angle = 35, hjust = 1)
    ) +
    ggtitle("Cumulative time spent interacting with patient by category of HCW") +
    xlab("") +
    ylab("Cumulative time interacting (h)")

# Violin plot
sum_length_cat %>%
  ggplot( aes(x=cat, y=sum_cat/3600, fill=cat)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=0.4, alpha=0.9) +
    theme_bw() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11),
      axis.text.x = element_text(angle = 35, hjust = 1)
    ) +
    ggtitle("Cumulative time spent interacting with patient by category of HCW") +
    xlab("") +
    ylab("Cumulative time interacting (h)")

```



## PA-PA INTERACTIONS
```{r}
k_RP <- list_rea[[poincare]] #%>% filter(length > 300)
k_EH <- list_rea[[herriot]] #%>% filter(length > 300)

table(k_RP$from_status, k_RP$to_status)
k_RP %>% filter(from_status == "PA" & to_status == "PA")
k_RP %>% filter(from_status == "PA" & to_status == "PA") %>% group_by(from,to) %>% summarise(len = sum(length))

table(k_EH$from_status, k_EH$to_status)
k_EH %>% filter(from_status == "PA" & to_status == "PA")
k_EH %>% filter(from_status == "PA" & to_status == "PA") %>% group_by(from) %>% summarise(len = sum(length))
```

## Raymond Poincaré double rooms hypothesis
```{r}
### HYP : "001-0038-B-S" and "001-0039-B-F" are in the same room
## ORDER FROM/TO
temp_a <- list_rea[[poincare]] %>%
  filter(from %in% c("001-0038-B-S", "001-0039-B-F") 
         | to %in% c("001-0038-B-S", "001-0039-B-F")) %>%
  filter(!(from_status == "PA" & to_status == "PA")) %>%
  mutate(n_from = ifelse((from == "001-0038-B-S" | from == "001-0039-B-F"), from, to  )
         , n_to = ifelse((to == "001-0038-B-S" | to == "001-0039-B-F"), from, to))


pe_a <- unique(c(temp_a$to[temp_a$to_status == "PE"]))
overlap_a <- data.frame()

for (individual in pe_a) {
  # Filter to keep only HCW's interaction
  interactions <- temp_a %>%
    filter(n_to == individual)
  
  # If the HCW interacts with both patients
  if (nrow(interactions) >= 2) {
    # double for loop to check if i and [j=i+1;n] are overlapping] for i 1:nrow(interaction)
    for (i in 1:(nrow(interactions)-1)) {
      for (j in (i+1):nrow(interactions)) {
        # Check if overlapping
        if (interactions$date_posix_first[i] <= (interactions$date_posix_first[j] + interactions$length[j]) &&
            (interactions$date_posix_first[i] + interactions$length[i]) >= interactions$date_posix_first[j]) {
          if (interactions$n_from[i] != interactions$n_from[j]){
          overlap_a <- bind_rows(overlap_a, interactions[c(i, j), ]) 
          }
        }
      }
    }
  }
}
rm(pe_a)
rm(interactions)
rm(temp_a)

summary(overlap_a)
```


```{r}
### HYP : "001-0127-B-A" and "001-0128-Z-K" are in the same room

temp_b <- list_rea[[poincare]] %>%
  filter(from %in% c("001-0127-B-A", "001-0128-Z-K" ) 
         | to %in% c("001-0127-B-A", "001-0128-Z-K" )) %>%
  filter(!(from_status == "PA" & to_status == "PA")) %>%
  mutate(n_from = ifelse((from == "001-0127-B-A" | from == "001-0128-Z-K"), from, to  )
         , n_to = ifelse((to == "001-0127-B-A" | to == "001-0128-Z-K"), from, to))


pe_b <- unique(c(temp_b$to[temp_b$to_status == "PE"]))
overlap_b <- data.frame()

for (individual in pe_b) {
  # Filter to keep only HCW's interaction
  interactions <- temp_b %>%
    filter(n_to == individual)
  
  # If the HCW interacts with both patients
  if (nrow(interactions) >= 2) {
    # double for loop to check if i and [j=i+1;n] are overlapping] for i 1:nrow(interaction)
    for (i in 1:(nrow(interactions)-1)) {
      for (j in (i+1):nrow(interactions)) {
        # Check if overlapping
        if (interactions$date_posix_first[i] <= (interactions$date_posix_first[j] + interactions$length[j]) &&
            (interactions$date_posix_first[i] + interactions$length[i]) >= interactions$date_posix_first[j]) {
          if (interactions$n_from[i] != interactions$n_from[j]){
          overlap_b <- bind_rows(overlap_b, interactions[c(i, j), ]) 
          }
        }
      }
    }
  }
}
rm(pe_b)
rm(interactions)
rm(temp_b)

summary(overlap_b)
```
<!-- ################################# GARBAGE ############################## -->

