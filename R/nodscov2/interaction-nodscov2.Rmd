---
title: "interaction-nodscov2"
author: "Olivier GAUFRÈS"
date: "2024-05-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
#library(tidyverse)
library(ggplot2)
library(lubridate)
```

```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)

data_path <- file.path(wd,"..", "..", "data")
observed_path <- file.path(data_path,"data-observed")
synthetic_path <- file.path(data_path, "data-synthetic-graphs")
simplified_path <- file.path(data_path, "data-simplified")
expanded_path <- file.path(data_path,"data-expanded")
nodscov2_path <- file.path(data_path, "data-nodscov2") 
```

### WIP 

## NodsCov2 data (not shared)
```{r}
load("Y:/ogaufres/projet-pacri/data/data-nodscov2/admission_ctc_nodscov2.RData")
load("Y:/ogaufres/projet-pacri/data/data-nodscov2/list_ward.RData")
```

## FIXING ENCODING
```{r}
Encoding(admission$hospital) <- 'latin1'
```

## (TEMP)
```{r, include = FALSE}
# write.csv2(admission, file = file.path(nodscov2_path, "nodscov2-csv","admission-nodscov2.csv"), row.names = FALSE)
# 
# sapply(names(list_ward),
#  function (x) write.csv2(list_ward[[x]],
#                          file = file.path(nodscov2_path,"nodscov2-csv",paste(x,"csv",sep="." )),
#                          row.names = FALSE)   )
```


## Data structure
```{r}
### ADMISSION = Individual's info
head(admission)
admission %>% distinct(hospital)

### LIST_WARD = LIST OF DATAFRAMES, EACH DF CONTAINS WARDS' INTERACTIONS
# Wards names
names(list_ward)
# Structures of wards df
head(list_ward$`Raymond_Poincare-Reanimation-20200506-20200507`)
```


## Individual proportions
```{r}
head(admission)

## Patients / HCW in all wards/hospitals
table(admission$status)

## Patients / HCW by cat (NA == patients)
table(admission$status, admission$cat, useNA = "always") 

## Proportion of individuals/ward etc..
table(admission$hospital, admission$ward)
```


## "FILTRATION"
```{r}
admission %>% filter(ward == "Reanimation")

## Ind in each reanimation ward
admission %>% filter(ward == "Reanimation") %>% group_by(hospital) %>% summarise( n = n(), .groups = "drop")

## Cat in each reanimation ward
admission %>% filter(ward == "Reanimation") %>% group_by(hospital, cat) %>% summarise( n = n(), .groups = "drop")

# admission %>% filter(ward == "Reanimation" | ward == "ReaChirurgie")
# 
# ## Ind in each reanimation ward
# admission %>% filter(ward == "Reanimation"| ward == "ReaChirurgie") %>% group_by(hospital) %>% summarise( n = n(), .groups = "drop")
# 
# ## Cat in each reanimation ward
# admission %>% filter(ward == "Reanimation"| ward == "ReaChirurgie") %>% group_by(hospital, cat) %>% summarise( n = n(), .groups = "drop")
```


## PLOTS
```{r}
## Reanimation wards
admission %>%
  filter(ward == "Reanimation" ) %>%
  group_by(hospital, cat) %>%
  summarise( n = n(), .groups = "drop") %>%
    ggplot(., aes(x = cat, y = n)) +
    geom_bar(stat = "identity") +
    facet_grid(cols = vars(hospital)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 35, hjust = 1))

## ReaChirurgie wards (For HC LYON EDOUARD HERRIOT 's REACHIRURGIE WARD)
admission %>%
  filter(ward == "ReaChirurgie") %>%
  group_by(hospital, cat) %>%
  summarise( n = n(), .groups = "drop") %>%
    ggplot(., aes(x = cat, y = n)) +
    geom_bar(stat = "identity") +
    facet_grid(cols = vars(hospital)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 35, hjust = 1))


```


## DF of interest
```{r}
## We keep wards with the lowest number of visitors (hyp. no visitors)
keep_names <- c("Raymond_Poincare-Reanimation-20200506-20200507",
          "Edouard_Herriot-Reanimation-20200609-20200610")

list_rea <- list_ward[keep_names]
```


## MODIFY INDIVIDUAL IDS (include PA/PE in id)
```{r}
## (TEMPORARY)
admission_rea <- admission %>%
  filter(ward == "Reanimation") %>% 
  filter(hospital != "APHP - NECKER ENFANTS MALADES")

table(admission_rea$hospital, admission_rea$cat)
rm(admission_rea)
## END (TEMPORARY)



## FILTER ADMISSION
admission_keep <- admission %>%
  ## Remove visitors/admin/logistics/investigators
  filter(ward == "Reanimation") %>% 
  filter(hospital != "APHP - NECKER ENFANTS MALADES") %>%
  filter(!(cat %in% c("administration",
                  "investigation",
                  "logistic",
                  "visitor"))) %>%
  ## ADD PE/PA IN ADMISSION'S IDs (id)
  mutate(id_bis = paste0(status,"-",id))


list_rea <- list_ward[keep_names]
## FILTER THE DATAFRAMES
list_rea <- lapply(list_rea, function(x) {
  ## FILTER INTERACTIONS TO KEEP ONLY HCW AND PATIENTS
  x <- x%>% filter(from %in% admission_keep$id & to %in% admission_keep$id)
  ## ADD INFO OF THE STATUS FOR INDIVIDUALS
  x <- left_join(x, admission_keep %>% select(id, status), by = c("from" = "id")) %>%
    rename(from_status = status) %>%
    left_join(admission_keep %>% select(id, status), by = c("to" = "id")) %>%
    rename(to_status = status)
})
```


## DISTRIBUTIONS
```{r}
poincare <- "Raymond_Poincare-Reanimation-20200506-20200507"
herriot <- "Edouard_Herriot-Reanimation-20200609-20200610"


data_rea <- bind_rows(
  mutate(list_rea[[poincare]], hospital = "Raymond Poicaré"),
  mutate(list_rea[[herriot]], hospital = "Edouard Herriot") ) %>%
  mutate(type_int = paste0(from_status, "-", to_status)) %>%
  mutate(type_int = ifelse(type_int == "PA-PE", "PE-PA", type_int))


## n / type of int
data_rea %>%
  group_by(hospital, type_int) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = type_int, y = n)) +
  geom_bar(stat = "identity") +
  facet_grid(cols = vars(hospital)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(title = "Distribution of interaction in Reanimation")

# n distribution / hour
data_rea %>%
  group_by(hospital, hour(date_posix_first), type_int) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(hour = `hour(date_posix_first)`) %>%
  ggplot(aes(x = hour, y = n)) +
  geom_bar(stat = "identity") +
  facet_grid(cols = vars(type_int), rows = vars(hospital)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(title = "Distribution of Intervals in Reanimation")
```

## PA-PA INTERACTIONS
```{r}


k_RP <- list_rea[[poincare]] #%>% filter(length > 300)

k_EH <- list_rea[[herriot]] #%>% filter(length > 300)

table(k_RP$from_status, k_RP$to_status)
k_RP %>% filter(from_status == "PA" & to_status == "PA")
k_RP %>% filter(from_status == "PA" & to_status == "PA") %>% group_by(from,to) %>% summarise(len = sum(length))

table(k_EH$from_status, k_EH$to_status)
k_EH %>% filter(from_status == "PA" & to_status == "PA")
k_EH %>% filter(from_status == "PA" & to_status == "PA") %>% group_by(from) %>% summarise(len = sum(length))
## we can delete PA-PA int in EH ()
```

## Raymond Poincaré double rooms hypothesis
```{r}
### HYP : "001-0038-B-S" and "001-0039-B-F" are in the same room
## ORDER FROM/TO
temp_a <- list_rea[[poincare]] %>%
  filter(from %in% c("001-0038-B-S", "001-0039-B-F") 
         | to %in% c("001-0038-B-S", "001-0039-B-F")) %>%
  filter(!(from_status == "PA" & to_status == "PA")) %>%
  mutate(n_from = ifelse((from == "001-0038-B-S" | from == "001-0039-B-F"), from, to  )
         , n_to = ifelse((to == "001-0038-B-S" | to == "001-0039-B-F"), from, to))


pe_a <- unique(c(temp_a$to[temp_a$to_status == "PE"]))
overlap_a <- data.frame()

for (individual in pe_a) {
  # Filter to keep only HCW's interaction
  interactions <- temp_a %>%
    filter(n_to == individual)
  
  # If the HCW interacts with both patients
  if (nrow(interactions) >= 2) {
    # double for loop to check if i and [j=i+1;n] are overlapping] for i 1:nrow(interaction)
    for (i in 1:(nrow(interactions)-1)) {
      for (j in (i+1):nrow(interactions)) {
        # Check if overlapping
        if (interactions$date_posix_first[i] <= (interactions$date_posix_first[j] + interactions$length[j]) &&
            (interactions$date_posix_first[i] + interactions$length[i]) >= interactions$date_posix_first[j]) {
          if (interactions$n_from[i] != interactions$n_from[j]){
          overlap_a <- bind_rows(overlap_a, interactions[c(i, j), ]) 
          }
        }
      }
    }
  }
}
rm(pe_a)
rm(interactions)
rm(temp_a)

summary(overlap_a)
```


```{r}
### HYP : "001-0127-B-A" and "001-0128-Z-K" are in the same room

temp_b <- list_rea[[poincare]] %>%
  filter(from %in% c("001-0127-B-A", "001-0128-Z-K" ) 
         | to %in% c("001-0127-B-A", "001-0128-Z-K" )) %>%
  filter(!(from_status == "PA" & to_status == "PA")) %>%
  mutate(n_from = ifelse((from == "001-0127-B-A" | from == "001-0128-Z-K"), from, to  )
         , n_to = ifelse((to == "001-0127-B-A" | to == "001-0128-Z-K"), from, to))


pe_b <- unique(c(temp_b$to[temp_b$to_status == "PE"]))
overlap_b <- data.frame()

for (individual in pe_b) {
  # Filter to keep only HCW's interaction
  interactions <- temp_b %>%
    filter(n_to == individual)
  
  # If the HCW interacts with both patients
  if (nrow(interactions) >= 2) {
    # double for loop to check if i and [j=i+1;n] are overlapping] for i 1:nrow(interaction)
    for (i in 1:(nrow(interactions)-1)) {
      for (j in (i+1):nrow(interactions)) {
        # Check if overlapping
        if (interactions$date_posix_first[i] <= (interactions$date_posix_first[j] + interactions$length[j]) &&
            (interactions$date_posix_first[i] + interactions$length[i]) >= interactions$date_posix_first[j]) {
          if (interactions$n_from[i] != interactions$n_from[j]){
          overlap_b <- bind_rows(overlap_b, interactions[c(i, j), ]) 
          }
        }
      }
    }
  }
}
rm(pe_b)
rm(interactions)
rm(temp_b)
rm(interactions)

summary(overlap_b)
```


## EXPORT DATA TO CSV
```{r}
# data <- list_rea[[poincare]]
# begin_date <- as.POSIXct(min(data$date_posix_first))
# end_date <- as.POSIXct(max(data$date_posix_first + data$length))
# time_spent <- end_date - begin_date
# 
# n_subdivisions <- as.integer(time_spent) * 24 * 60 * 2 ## Time spent * hours * minutes * 2 (number of time subdivisions)
# interactions_tot_R <- data.frame(from = NA, to = NA, time = NA, from_status = NA, to_status = NA )
# 
# lin_a <- Sys.time()
# for(t in 1:n_subdivisions){
#   interactions_t <- data %>%
#     filter(date_posix_first <= begin_date + (t)*30 & date_posix_first + length >= begin_date + (t+1)*30) %>%
#     mutate(time = t) %>%
#     select(from, to, time, from_status, to_status)
# 
#   if (dim(interactions_t)[1]!= 0){
#   interactions_tot_R <- interactions_tot_R %>% bind_rows(interactions_t)
#   }
# }
# lin_b <- Sys.time()
# print(lin_b-lin_a)
# write.csv2(interactions_tot_R, file = file.path(wd,"..", "..", "data", "data-nodscov2", "int_tot_RP_test.csv"), row.names = F)

```

<!-- ################################# GARBAGE ############################## -->

