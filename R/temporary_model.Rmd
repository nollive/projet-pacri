---
title: "model-temporary"
author: "Olivier GAUFRÃˆS"
date: "2024-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
```

## DATA IMPORT (TEMPORARY)
```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)
simplified_path <- file.path(wd,"..","data-simplified")

## xlsx files
cat_groupings <- read_excel(path = file.path(wd,"..","data-observed","cat_groupings.xlsx"), col_names= TRUE)

## csv files
admission <- read.csv2(file = file.path(simplified_path, "admission.csv"), header = TRUE, sep = ";")
agenda <- read.csv2(file = file.path(simplified_path, "agenda.csv"), header = TRUE, sep = ";")
mat_ctc <- read.csv2(file = file.path(simplified_path, "mat_ctc.csv"), header = TRUE, sep = ";")

#Graph chosen (TEMPORARY)
graph_1 <- read.csv2(file = file.path(simplified_path, "graph_1.csv"), header = TRUE, sep = ";") %>% 
                      mutate(date_posix = as.POSIXct(x = date_posix, format = "%Y-%m-%d %H:%M:%S"))

```


## Model
```{r}
####################
## Initialization ##
####################


## Dimensions

begin_date <- as.POSIXct("2009-07-06 00:00:00")
end_date <- as.POSIXct("2009-09-28 00:00:00")
time_spent <- end_date - begin_date

n_individuals <- as.integer(admission %>%
  distinct(id) %>%
  count())

n_subdivisions <- as.integer(time_spent) * 24 * 60 * 2 ## Time spent * hours * minutes * 2 (number of time subdivisions)


## Room environment stores the viral load of each room
## Assuming each patient is in an individual room

rooms <- admission %>%
  distinct(id) %>%
  filter(substr(id, 1, 2) == "PA") %>%
  mutate(room = as.factor(row_number())) %>%
  mutate(id_room = as.factor(row_number())) %>%
  select(id_room,room, id)

rooms <- rooms %>%
  bind_rows(data.frame(room = "Restroom", id = "PE", id_room = as.factor(nrow(rooms) + 1))) %>%
  bind_rows(data.frame(room = "Corridor", id = "ALL", id_room = as.factor(nrow(rooms) + 2)))



environment <- rooms %>%
  distinct(room) %>%
  mutate(env = 0) %>%
  mutate(id_room = rooms$id_room) %>%
  select(room, id_room, env)


## Individual location stores, for every individual, the location where happened his last interaction (and the location he will be after -> might be deleted after, depends on the structure of code below)
## Initially, every patient is in his/her room & HCW in HCW's rest room
individual_location <- rooms %>%
  mutate(previous_location = room) %>%
  mutate(future_location = NA) %>%
  filter(id != "ALL") %>%
  select(id, previous_location, future_location)

synthetic_path <- file.path(wd, "..", "data-synthetic-graphs")
list_graph <- list.files(path = file.path(synthetic_path))


## Create our 2D array I containing the information whether our individual is susceptible (0), infected (1), recovered (2) or not in the ward anymore (-1)

# for (i in seq_along(list_graph)){
#   index <- gsub("[^0-9]", "", list_graph[i]) ## Graphs are not listed in order
#   assign(paste0("I_", index), 
#          array(data = 0, 
#                dim = c(n_individuals, n_subdivisions+1), 
#                dimnames = list(paste0("Individual_", 1:n_individuals), paste0("Status_for_Time_", 0:n_subdivisions))))
# }


# TEMPORARY
I_1 <- array(data = 0, 
             dim = c(n_individuals, n_subdivisions+1),
             dimnames = list(paste0("Individual_", 1:n_individuals), paste0("Status_for_Time_", 0:n_subdivisions)))
# TEMPORARY


```



## Update of the model for each subdivision of time
```{r}
#TEMPORARY
pInf <- 0.3
pRec <- 0.2
#TEMPORARY
## Assigning the index patient --> TEMPORARY, need to be in args!
I_1[1,1] <- 1 #TEMPORARY

a <-  Sys.time()


# Loop every subdivision of time (30s)
for (t in 2:2) {
  
  # Get the interactions happening at the time begin_date + t*30
  interactions <- graph_1 %>%
    filter(date_posix <= begin_date + t*30 & date_posix + length >= begin_date + t*30)
  print(dim(interactions))
  print(dim(admission))
  ##############################
  ## Update the localisations ##
  ##############################
  
  ############### TEMPORARY ######################## (not working because an individual can have simultaneous contacts with PA AND PE respectfully, the localisation will be wrong)
  # For the individuals interacting at t
  if (dim(interactions)[1] != 0){
    for (i in 1:dim(interactions)[1]) {
      
      ## Interactions between HCW & Patients take place in patient's room (FROM = PA AND TO = PE)
      if  (substr(interactions[i, "from"], 1, 2) == "PA" && substr(interactions[i, "to"], 1, 2) == "PE") { 
        # Room where the interaction takes place
        room_int <- rooms %>%filter(id == interactions[i, "from"]) %>% pull(room)
        # Update the localisation of PA & PE
        individual_location <- individual_location %>%
          mutate(future_location = ifelse(id == interactions[i, "from"], room_int, future_location)) %>%
          mutate(future_location = ifelse(id == interactions[i, "to"], room_int, future_location))
      }
      ## Interactions between HCW & Patients take place in patient's room (FROM = PE AND TO = PA)
      if  (substr(interactions[i, "from"], 1, 2) == "PE" && substr(interactions[i, "to"], 1, 2) == "PA") {
        # Room where the interaction takes place
        room_int <- rooms %>%filter(id == interactions[i, "to"]) %>% pull(room)
        # Update the localisations of PA & PE
        individual_location <- individual_location %>%
          mutate(future_location = ifelse(id == interactions[i, "from"], room_int, future_location)) %>%
          mutate(future_location = ifelse(id == interactions[i, "to"], room_int, future_location))
      }
        
      
      ## Interactions between patients take place in the corridor
      if  (substr(interactions[i, "from"], 1, 2) == "PA" && substr(interactions[i, "to"], 1, 2) == "PA") { 
        individual_location <- individual_location %>%
          mutate(future_location = ifelse(id == interactions[i, "from"], "Corridor", future_location)) %>%
          mutate(future_location = ifelse(id == interactions[i, "to"], "Corridor", future_location))
      }
      
      
      ## Interactions between HCW take place in the HCW's rest room
      if  (substr(interactions[i, "from"], 1, 2) == "PE" && substr(interactions[i, "to"], 1, 2) == "PE") { 
        individual_location <- individual_location %>%
          mutate(future_location = ifelse(id == interactions[i, "from"], "Restroom", future_location)) %>%
          mutate(future_location = ifelse(id == interactions[i, "to"], "Restroom", future_location))
      }
    }
  }
  # For the individuals not interacting at t
  for (i in seq_along(admission["id"] %>% filter(!(id %in% interactions[["from"]]) & !(id %in% interactions[["to"]])))){
    ind <- admission$id[i]
    print(dim(admission))
    room_assigned <- rooms %>% filter(id == ind) %>% pull(room)
    room_prev <- individual_location %>% filter(id == ind) %>% pull(previous_location)
    
    ## Rules for patients that don't have an interaction
    ## Patients stay in their room (thus if not in Restroom (chamber or corridor), they will go to their room)
    if  (substr(ind, 1, 2) == "PA"){
      if (room_prev == "Restroom"){
        individual_location <- individual_location %>% 
          mutate(future_location = ifelse(id == ind , "Corridor", future_location)) ## Should not be possible to be in HCWs room but?
      }
      else{
        individual_location <- individual_location %>% 
          mutate(future_location = ifelse(id == ind , "Restroom", future_location))
      }
    }
    
    ## Rules for HCWs that don't have an interaction
    # If at t-1, the HCW is either in the corridor/restroom, he will go/stay to the restroom and if he was in a patient's room, he will go to the corridor
    if  (substr(ind, 1, 2) == "PE"){
      # If HCW is in a patient's room -> Corridor
      if (room_prev <= 62 & room_prev >= 1){
        individual_location <- individual_location %>% 
          mutate(future_location = ifelse(id == ind , "Corridor", future_location)) # TEMPORARY, SHOULD CHANGE ID OF CORRIDOR TO nb patient +1 etc
      }
      
      # If HCW is in the Corridor/Restroom  -> Restroom
      else{
        individual_location <- individual_location %>% 
          mutate(future_location = ifelse(id == ind , "Restroom", future_location))
      }
    }
  }
  ############### TEMPORARY ########################
  
  
  ############################
  ## Update the environment ##
  ############################
  mu <- 0.01 # To define, inactivation rate
  nu <- 0.1 # To define, shedding of an individual
  for (r in 1:dim(environment)[1]){
    name_r <- environment[r,]$room
    ind_r <- individual_location %>% filter(future_location == name_r ) # individuals in room r
    
    infected_r <- 0 # number of infected individuals in room r
    for (i in seq_along(ind_r$id)){
      if (I_1[i,t-1] == 1){
        infected_r <- infected_r +1
        }
    # Update the environment in room r
    environment[r, "env"] <- max(0, environment[r, "env"] * exp(-mu) + (nu / mu) * (infected_r / nrow(ind_r)))
    }
  }
  
  
  
  #######################
  ## Update the status ## (at the end of the subdivision of time)
  #######################
  for (patient in 1:dim(I_1)[1]) {
    ## Susceptible (0) --> Infected (1)
    if (I_1[patient,t-1] == 0 && runif(n = 1, min = 0, max = 1) <= pInf) {
      I_1[patient,t] <- 1
    }
      ## Infected (1) --> Recovered (2)
    if (I_1[patient,t-1] == 1 && runif(n = 1, min = 0, max = 1) <= pRec) {
      I_1[patient,t] <- 2
    }  
  } 
}

b <-  Sys.time()
print(b-a)
```