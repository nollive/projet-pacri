---
title: "Network simplifier"
author: "Olivier GAUFRÃˆS"
date: "2024-04-11"
output: html_document
---

## Libraries
```{r eval=false}
library(dplyr)
library(readxl)
```

```{r}
wd <- getwd()
knitr::opts_chunk$set(root.dir = wd)
observed_path <- file.path(wd,"..", "data", "data-observed")
simplified_path <- file.path(wd,"..", "data", "data-simplified")

## xlsx files
cat_groupings <- read_excel(path = file.path(observed_path,"cat_groupings.xlsx"), col_names= TRUE)

## csv files
toy_admission <- read.csv2(file = file.path(observed_path, "toy_admission.csv"), header = TRUE, sep = ";")
toy_agenda <- read.csv2(file = file.path(observed_path, "toy_agenda.csv"), header = TRUE, sep = ";")
toy_mat_ctc <- read.csv2(file = file.path(observed_path, "toy_mat_ctc.csv"), header = TRUE, sep = ";")
```


## Sorting according to our assumptions
```{r}
## We only keep interactions between individuals of the same ward. Thus, the individuals that had an inter-ward interaction, they will now have no interaction (cross-ward's infection will be taken into account with \alpha parameter)
chosen_ward <- "Menard 1" ## Ward of our choice


admission <- filter(toy_admission, ward == chosen_ward)
write.csv2(admission, file = file.path(simplified_path, "admission.csv"), sep = ";", row.names = FALSE)

agenda <- filter(toy_agenda, ward == chosen_ward)
write.csv2(agenda, file = file.path(simplified_path, "agenda.csv"), sep = ";", row.names = FALSE)

mat_ctc <- filter(toy_mat_ctc, from %in% admission$id & to %in% admission$id) ## Both induviduals must be from the same ward
write.csv2(mat_ctc, file = file.path(simplified_path, "mat_ctc.csv"), sep = ";", row.names = FALSE)
```


## Sorting the synthetic graphs according to our assumptions
```{r}
synthetic_path <- file.path(wd, "..", "data", "data-synthetic-graphs")
list_graph <- list.files(path = file.path(synthetic_path))
dir.create(file.path(wd,"..", "data", "data-simplified"))

for (i in seq_along(list_graph)){
  index <- gsub("[^0-9]", "", list_graph[i])
  df <- filter(read.csv2(file = file.path(synthetic_path, list_graph[i]), header = TRUE), 
                      from %in% admission$id & to %in% admission$id) %>% 
                      mutate(date_posix = as.POSIXct(date_posix))
  
  write.csv2(df, file = file.path(wd, "..", "data", "data-simplified", paste0("graph_", index, ".csv")), sep = ";", row.names = FALSE)
}



# ## Example of a synthetic graph before reducing it to only a ward
# toy_graph <- read.csv2(file = file.path(synthetic_path, list_graph[1]), header = TRUE)
# # To compare
# dim(toy_graph)[1] - dim(graph_1)[1]
# dim(toy_admission)[1] - dim(admission)[1]
```


## Initialisation of our data arrays
```{r}
# begin_date <- as.POSIXct("2009-07-06 00:00:00")
# end_date <- as.POSIXct("2009-09-28 00:00:00")
# time_spent <- end_date - begin_date
# 
# ## Dimensions
# n_individuals <- as.integer(count(distinct(admission, id))) ##SELECT DISTINCT INDIVIDUAL FROM       ADMISSION?
# n_subdivisions <- as.integer(time_spent) * 24 * 60 * 2 ## Time spent * hours * minutes * 2 (number of time subdivisions)

# for (i in seq_along(list_graph)){
#   index <- gsub("[^0-9]", "", list_graph[i]) ## Graphs are not listed in order
#   
#   ## Create our 3D array P containing the interactions between our individuals, the room where this interaction takes place and when
#   assign(paste0("P_", index), array(data = NA, dim = c(n_individuals, n_individuals, n_subdivisions))) ## n_individuals * n_individuals * n_subdivisions 
#   
#   ## Create our 2D array I containing the information whether our individual is susceptible (0), infected (1), recovered (2) or not in the ward anymore (-1)
#   assign(paste0("I_", index), array(data = -1, dim = c(n_individuals, n_subdivisions))) ## n_individuals *
# }

## 
## Erreur : impossible d'allouer un vecteur de taille 9.9 Go
```





